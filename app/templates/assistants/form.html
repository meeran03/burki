{% extends "base.html" %}

{% block title %}
{% if assistant %}Edit Assistant{% else %}Create Assistant{% endif %} - Buraaq Voice AI
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 p-6">
    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header Section -->
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-700 p-8">
            <div class="absolute inset-0 bg-black/20"></div>
            <div class="relative z-10">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-white">
                            {% if assistant %}Edit Assistant: {{ assistant.name }}{% else %}Create New Assistant{% endif %}
                        </h1>
                        <p class="mt-2 text-blue-100">
                            {% if assistant %}Update assistant details and AI configuration.{% else %}Configure your voice AI assistant with advanced settings.{% endif %}
                        </p>
                    </div>
                    <div class="mt-4 lg:mt-0">
                        <a href="/assistants" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-white/10 hover:bg-white/20 rounded-lg border border-white/20 transition-colors">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Back to Assistants
                        </a>
                    </div>
                </div>
            </div>
            <!-- Decorative background elements -->
            <div class="absolute -bottom-16 -right-16 w-64 h-64 rounded-full bg-white/5 backdrop-blur-sm"></div>
        </div>

        <!-- Progress Indicator -->
        <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Configuration Progress</h2>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                    <span class="text-green-400 text-sm">Ready to Configure</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <span class="text-white text-sm font-bold">1</span>
                    </div>
                    <span class="text-gray-300 text-sm">Basic Info</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">2</span>
                    </div>
                    <span class="text-gray-400 text-sm">AI Models</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">3</span>
                    </div>
                    <span class="text-gray-400 text-sm">Call Settings</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">4</span>
                    </div>
                    <span class="text-gray-400 text-sm">Integration</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">5</span>
                    </div>
                    <span class="text-gray-400 text-sm">Advanced</span>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form method="POST" class="space-y-8">
            <!-- Section 1: Basic Information -->
            <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-blue-500/10 to-purple-500/10 border-b border-gray-700/50">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Basic Information</h3>
                            <p class="text-gray-400 text-sm">Core details about your assistant</p>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Assistant Name -->
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-300 mb-2">Assistant Name</label>
                            <input type="text" name="name" id="name" required
                                value="{{ assistant.name if assistant else '' }}"
                                class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                placeholder="My Voice Assistant">
                        </div>

                        <!-- Phone Number -->
                        <div>
                            <label for="phone_number" class="block text-sm font-medium text-gray-300 mb-2">Phone Number</label>
                            {% if phone_numbers %}
                            <select name="phone_number" id="phone_number" required
                                class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <option value="">-- Select a phone number --</option>
                                {% for phone in phone_numbers %}
                                <option value="{{ phone.phone_number }}" {% if assistant and assistant.phone_number == phone.phone_number %}selected{% endif %}>
                                    {{ phone.friendly_name }} ({{ phone.phone_number }})
                                </option>
                                {% endfor %}
                                <option value="custom">Custom phone number</option>
                            </select>
                            <div id="custom_phone_container" class="mt-3 hidden">
                                <input type="text" id="custom_phone_number" placeholder="+1234567890"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <p class="mt-2 text-xs text-gray-400">Enter in E.164 format (e.g., +1234567890)</p>
                            </div>
                            {% else %}
                            <input type="text" name="phone_number" id="phone_number" required
                                value="{{ assistant.phone_number if assistant else '' }}"
                                placeholder="+1234567890"
                                class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            <p class="mt-2 text-xs text-gray-400">
                                No Twilio phone numbers found. Enter in E.164 format.
                                {% if not assistant %}
                                <a href="https://www.twilio.com/console/phone-numbers/search" target="_blank" class="text-blue-400 hover:text-blue-300 underline">
                                    Purchase a number from Twilio
                                </a>
                                {% endif %}
                            </p>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="lg:col-span-2">
                            <label for="description" class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                            <textarea id="description" name="description" rows="3"
                                class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                placeholder="Describe your assistant's purpose and capabilities">{{ assistant.description if assistant else '' }}</textarea>
                        </div>

                        <!-- Active Status -->
                        <div class="lg:col-span-2">
                            <div class="flex items-center space-x-3">
                                <input id="is_active" name="is_active" type="checkbox" 
                                    {% if not assistant or assistant.is_active %}checked{% endif %}
                                    class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-offset-gray-800">
                                <div>
                                    <label for="is_active" class="text-sm font-medium text-white">Active Assistant</label>
                                    <p class="text-xs text-gray-400">When active, the assistant can receive and handle calls</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: AI Configuration -->
            <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-purple-500/10 to-indigo-500/10 border-b border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">AI Configuration</h3>
                                <p class="text-gray-400 text-sm">Configure language models and voice settings</p>
                            </div>
                        </div>
                        <button type="button" onclick="toggleAIConfig()" class="text-purple-400 hover:text-purple-300 text-sm font-medium transition-colors">
                            <span id="ai-toggle-text">Configure</span>
                        </button>
                    </div>
                </div>
                <div id="ai-configuration" class="hidden p-6">
                    <!-- AI Tabs -->
                    <div class="border-b border-gray-700/50">
                        <nav class="flex space-x-8 px-6" aria-label="AI Configuration Tabs">
                            <button type="button" onclick="switchAITab('llm')" class="ai-tab active border-b-2 border-blue-500 py-4 px-1 text-sm font-medium text-blue-400" id="llm-tab">
                                Language Model
                            </button>
                            <button type="button" onclick="switchAITab('tts')" class="ai-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-300" id="tts-tab">
                                Text-to-Speech
                            </button>
                            <button type="button" onclick="switchAITab('stt')" class="ai-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-400 hover:text-gray-300" id="stt-tab">
                                Speech-to-Text
                            </button>
                        </nav>
                    </div>

                    <!-- LLM Tab Content -->
                    <div id="llm-content" class="ai-tab-content p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- LLM Provider Selection -->
                            <div class="lg:col-span-2">
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                    <label for="llm_provider" class="block text-sm font-medium text-gray-300">LLM Provider</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Choose Your AI Provider 🤖</div>
                                            <div class="space-y-2 text-xs">
                                                <div><strong>OpenAI:</strong> GPT-4o, GPT-3.5 - Reliable, general purpose</div>
                                                <div><strong>Anthropic:</strong> Claude models - Advanced reasoning, safety-focused</div>
                                                <div><strong>Google Gemini:</strong> Latest Google models - Multimodal capabilities</div>
                                                <div><strong>xAI Grok:</strong> Real-time data, less restrictive</div>
                                                <div><strong>Groq:</strong> Ultra-fast inference speed</div>
                                                <div><strong>Custom:</strong> Your own API endpoint</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select name="llm_provider" id="llm_provider" required
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    onchange="updateProviderOptions()">
                                    <option value="openai" {% if assistant and assistant.llm_provider == 'openai' %}selected{% endif %}>🚀 OpenAI (GPT Models)</option>
                                    <option value="anthropic" {% if assistant and assistant.llm_provider == 'anthropic' %}selected{% endif %}>🧠 Anthropic (Claude Models)</option>
                                    <option value="gemini" {% if assistant and assistant.llm_provider == 'gemini' %}selected{% endif %}>🌟 Google Gemini</option>
                                    <option value="xai" {% if assistant and assistant.llm_provider == 'xai' %}selected{% endif %}>⚡ xAI (Grok Models)</option>
                                    <option value="groq" {% if assistant and assistant.llm_provider == 'groq' %}selected{% endif %}>🔥 Groq (Ultra Fast)</option>
                                    <option value="custom" {% if assistant and assistant.llm_provider == 'custom' %}selected{% endif %}>🔧 Custom Endpoint</option>
                                </select>
                            </div>

                            <!-- Provider API Key -->
                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                    </svg>
                                    <label for="llm_provider_api_key" class="block text-sm font-medium text-gray-300">API Key</label>
                                    <span class="text-xs text-gray-500 italic">Required</span>
                                </div>
                                <input type="password" name="llm_provider_api_key" id="llm_provider_api_key"
                                    value="{{ assistant.llm_provider_config.api_key if assistant and assistant.llm_provider_config else '' }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="Enter your API key">
                                <p id="api-key-help" class="mt-2 text-xs text-gray-400">
                                    Enter your OpenAI API key
                                </p>
                            </div>

                            <!-- Provider Model -->
                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    <label for="llm_provider_model" class="block text-sm font-medium text-gray-300">Model</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Choose Your Model 🧠</div>
                                            <div id="model-help-content" class="space-y-2 text-xs">
                                                <div><strong>GPT-4o:</strong> Most advanced, best for complex tasks</div>
                                                <div><strong>GPT-4o-mini:</strong> Faster and cheaper, good balance</div>
                                                <div><strong>GPT-3.5-turbo:</strong> Fast and cost-effective</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select name="llm_provider_model" id="llm_provider_model"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>

                            <!-- Custom Base URL (for some providers) -->
                            <div id="base-url-container" class="lg:col-span-2 hidden">
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                                    </svg>
                                    <label for="llm_provider_base_url" class="block text-sm font-medium text-gray-300">Base URL</label>
                                    <span class="text-xs text-gray-500 italic">Optional</span>
                                </div>
                                <input type="text" name="llm_provider_base_url" id="llm_provider_base_url"
                                    value="{{ assistant.llm_provider_config.base_url if assistant and assistant.llm_provider_config else '' }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="https://api.example.com/v1">
                                <p id="base-url-help" class="mt-2 text-xs text-gray-400">
                                    Custom API endpoint URL (leave blank for default)
                                </p>
                            </div>

                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <label for="llm_temperature" class="block text-sm font-medium text-gray-300">Creativity Level (Temperature)</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">AI Creativity Control 🎨</div>
                                            <div class="space-y-2 text-xs">
                                                <div><strong>0.0-0.3:</strong> Very focused, predictable responses</div>
                                                <div><strong>0.4-0.7:</strong> Balanced creativity (Recommended for most uses)</div>
                                                <div><strong>0.8-1.0:</strong> More creative, varied responses</div>
                                                <div><strong>1.0+:</strong> Very creative, potentially unpredictable</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="number" step="0.1" min="0" max="2" name="llm_temperature" id="llm_temperature"
                                    value="{{ assistant.llm_settings.temperature if assistant and assistant.llm_settings else 0.7 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <div class="mt-1 text-xs text-gray-400">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">
                                        💡 Recommended: 0.7
                                    </span>
                                </div>
                            </div>

                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                    </svg>
                                    <label for="llm_max_tokens" class="block text-sm font-medium text-gray-300">Response Length (Max Tokens)</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Maximum Response Length 📏</div>
                                            <div class="space-y-2 text-xs">
                                                <div><strong>~4 tokens = 1 word</strong></div>
                                                <div><strong>500 tokens:</strong> ~125 words (short answers)</div>
                                                <div><strong>1000 tokens:</strong> ~250 words (recommended for calls)</div>
                                                <div><strong>2000+ tokens:</strong> Longer responses (may feel unnatural in calls)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="number" step="50" min="50" max="4000" name="llm_max_tokens" id="llm_max_tokens"
                                    value="{{ assistant.llm_settings.max_tokens if assistant and assistant.llm_settings else 1000 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <div class="mt-1 text-xs text-gray-400">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">
                                        💡 Recommended: 1000 tokens (~250 words)
                                    </span>
                                </div>
                            </div>

                            <div class="lg:col-span-2">
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C20.168 18.477 18.582 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    <label for="llm_system_prompt" class="block text-sm font-medium text-gray-300">AI Personality & Instructions</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Define Your AI's Personality 🎭</div>
                                            <div class="text-xs">
                                                This tells the AI how to behave during calls. Be specific about tone, knowledge areas, and conversation style. This is the most important setting for call quality!
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <textarea id="llm_system_prompt" name="llm_system_prompt" rows="4"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="You are a helpful voice assistant having a phone conversation. Keep your responses concise and natural.">{{ assistant.llm_settings.system_prompt if assistant and assistant.llm_settings else 'You are a helpful voice assistant having a phone conversation. Keep your responses concise and natural.' }}</textarea>
                                <div class="mt-2 p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                    <div class="text-xs text-blue-200">
                                        <strong>💡 Pro Tips:</strong> Mention your business type, preferred tone (friendly, professional), and any specific knowledge areas. Keep responses conversational for phone calls!
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-2">
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V1a1 1 0 011-1h2a1 1 0 011 1v8a1 1 0 01-1 1H5a1 1 0 01-1-1V1a1 1 0 011-1h2a1 1 0 011 1v3z"></path>
                                    </svg>
                                    <label for="welcome_message" class="block text-sm font-medium text-gray-300">Greeting Message</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">First Impression Matters! 👋</div>
                                            <div class="text-xs">
                                                This is the very first thing callers hear when they connect. Make it warm, professional, and set clear expectations about what your AI can help with.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <textarea id="welcome_message" name="welcome_message" rows="2"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="Hello! I'm your AI assistant. How can I help you today?">{{ assistant.llm_settings.welcome_message if assistant and assistant.llm_settings else 'Hello! I\'m your AI assistant. How can I help you today?' }}</textarea>
                                <div class="mt-2 text-xs text-gray-400">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-yellow-500/20 text-yellow-400">
                                        🎯 Keep it under 15 seconds when spoken
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TTS Tab Content -->
                    <div id="tts-content" class="ai-tab-content hidden p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                    </svg>
                                    <label for="tts_model_id" class="block text-sm font-medium text-gray-300">Voice Quality Model</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Voice Quality vs Speed ⚡🎵</div>
                                            <div class="space-y-2 text-xs">
                                                <div><strong>Multilingual v2:</strong> Highest quality, most natural emotions (slower)</div>
                                                <div><strong>Flash v2.5:</strong> Ultra-fast (~75ms), great for real-time conversations (Recommended)</div>
                                                <div><strong>Turbo v2.5:</strong> Good balance of speed and quality</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select name="tts_model_id" id="tts_model_id"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="eleven_multilingual_v2" {% if assistant and assistant.tts_settings and assistant.tts_settings.model_id == 'eleven_multilingual_v2' %}selected{% endif %}>🎭 Multilingual v2 (Best Quality)</option>
                                    <option value="eleven_flash_v2_5" {% if assistant and assistant.tts_settings and assistant.tts_settings.model_id == 'eleven_flash_v2_5' %}selected{% endif %}>⚡ Flash v2.5 (Ultra Fast - Recommended)</option>
                                    <option value="eleven_turbo_v2_5" {% if assistant and assistant.tts_settings and assistant.tts_settings.model_id == 'eleven_turbo_v2_5' %}selected{% endif %}>🚀 Turbo v2.5 (Balanced)</option>
                                </select>
                                <div class="mt-2 p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                    <p class="text-xs text-blue-200">
                                        <strong>💡 For Phone Calls:</strong> Flash v2.5 is recommended for natural conversations. Multilingual v2 if you prioritize voice quality over speed.
                                    </p>
                                </div>
                            </div>

                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <label for="tts_voice_id" class="block text-sm font-medium text-gray-300">Voice Character</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Choose Your Voice Personality 🎭</div>
                                            <div class="text-xs">
                                                Each voice has a unique personality and tone. Test different voices to find the one that best represents your brand and resonates with your callers.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select name="tts_voice_id" id="tts_voice_id"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="rachel" {% if assistant and assistant.tts_settings and assistant.tts_settings.voice_id == 'rachel' %}selected{% endif %}>👩 Rachel (Professional Female)</option>
                                    <option value="domi" {% if assistant and assistant.tts_settings and assistant.tts_settings.voice_id == 'domi' %}selected{% endif %}>👩‍💼 Domi (Warm Female)</option>
                                    <option value="bella" {% if assistant and assistant.tts_settings and assistant.tts_settings.voice_id == 'bella' %}selected{% endif %}>🌟 Bella (Friendly Female)</option>
                                    <option value="antoni" {% if assistant and assistant.tts_settings and assistant.tts_settings.voice_id == 'antoni' %}selected{% endif %}>👨 Antoni (Calm Male)</option>
                                    <option value="eli" {% if assistant and assistant.tts_settings and assistant.tts_settings.voice_id == 'eli' %}selected{% endif %}>👨‍💼 Eli (Professional Male)</option>
                                    <option value="josh" {% if assistant and assistant.tts_settings and assistant.tts_settings.voice_id == 'josh' %}selected{% endif %}>🎯 Josh (Confident Male)</option>
                                    <option value="custom">🔧 Custom Voice ID</option>
                                </select>
                                <div id="custom_voice_container" class="mt-3 hidden">
                                    <input type="text" id="custom_voice_id" name="tts_voice_id"
                                        value="{{ assistant.tts_settings.voice_id if assistant and assistant.tts_settings and assistant.tts_settings.voice_id not in ['rachel', 'domi', 'bella', 'antoni', 'eli', 'josh'] else '' }}"
                                        placeholder="Enter custom voice ID (e.g., 21m00Tcm4TlvDq8ikWAM)"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <p class="mt-2 text-xs text-gray-400">Enter your custom ElevenLabs voice ID from your dashboard</p>
                                </div>
                            </div>

                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    <label for="tts_latency" class="block text-sm font-medium text-gray-300">Response Speed</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">How Fast Should AI Respond? ⚡</div>
                                            <div class="space-y-1 text-xs">
                                                <div><strong>Ultra Low:</strong> Experimental, fastest possible (may have quality issues)</div>
                                                <div><strong>Low:</strong> Very fast, good for real-time conversations (Recommended)</div>
                                                <div><strong>Medium:</strong> Balanced speed and stability</div>
                                                <div><strong>High:</strong> Slower but most stable</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <select name="tts_latency" id="tts_latency"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="0" {% if assistant and assistant.tts_settings and assistant.tts_settings.latency == 0 %}selected{% endif %}>🚀 Ultra Low (Experimental)</option>
                                    <option value="1" {% if assistant and assistant.tts_settings and assistant.tts_settings.latency == 1 %}selected{% endif %}>⚡ Low (Recommended)</option>
                                    <option value="2" {% if assistant and assistant.tts_settings and assistant.tts_settings.latency == 2 %}selected{% endif %}>⚖️ Medium</option>
                                    <option value="3" {% if assistant and assistant.tts_settings and assistant.tts_settings.latency == 3 %}selected{% endif %}>🔒 High (Most Stable)</option>
                                </select>
                            </div>

                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <label for="tts_stability" class="block text-sm font-medium text-gray-300">Voice Consistency</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Voice Stability Control 🎯</div>
                                            <div class="space-y-1 text-xs">
                                                <div><strong>0.0-0.3:</strong> More variation, expressive but inconsistent</div>
                                                <div><strong>0.4-0.6:</strong> Balanced consistency (Recommended)</div>
                                                <div><strong>0.7-1.0:</strong> Very consistent, may sound monotone</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="number" step="0.1" min="0" max="1" name="tts_stability" id="tts_stability"
                                    value="{{ assistant.tts_settings.stability if assistant and assistant.tts_settings else 0.5 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <div class="mt-1 text-xs text-gray-400">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">
                                        💡 Sweet spot: 0.4-0.6
                                    </span>
                                </div>
                            </div>

                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                    </svg>
                                    <label for="tts_similarity_boost" class="block text-sm font-medium text-gray-300">Voice Accuracy</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">How Close to Original Voice? 🎯</div>
                                            <div class="space-y-1 text-xs">
                                                <div><strong>0.0-0.5:</strong> More creative interpretation</div>
                                                <div><strong>0.6-0.8:</strong> Balanced accuracy (Recommended)</div>
                                                <div><strong>0.9-1.0:</strong> Very close to original voice</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="number" step="0.1" min="0" max="1" name="tts_similarity_boost" id="tts_similarity_boost"
                                    value="{{ assistant.tts_settings.similarity_boost if assistant and assistant.tts_settings else 0.75 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <div class="mt-1 text-xs text-gray-400">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-orange-500/20 text-orange-400">
                                        💡 Recommended: 0.75
                                    </span>
                                </div>
                            </div>

                            <div>
                                <div class="flex items-center space-x-2 mb-2">
                                    <svg class="w-4 h-4 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m0 0V1a1 1 0 011-1h2a1 1 0 011 1v8a1 1 0 01-1 1h-2a1 1 0 01-1-1V4H8v5a1 1 0 01-1 1H5a1 1 0 01-1-1V1a1 1 0 011-1h2a1 1 0 011 1v3z"></path>
                                    </svg>
                                    <label for="tts_style" class="block text-sm font-medium text-gray-300">Speaking Style Variation</label>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Style & Expression Control 🎨</div>
                                            <div class="space-y-1 text-xs">
                                                <div><strong>0.0:</strong> Natural baseline voice (Recommended for business)</div>
                                                <div><strong>0.1-0.5:</strong> Slight style variation</div>
                                                <div><strong>0.6-1.0:</strong> More expressive, dramatic style</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="number" step="0.1" min="0" max="1" name="tts_style" id="tts_style"
                                    value="{{ assistant.tts_settings.style if assistant and assistant.tts_settings else 0.0 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                <div class="mt-1 text-xs text-gray-400">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-pink-500/20 text-pink-400">
                                        💡 Business calls: Keep at 0.0
                                    </span>
                                </div>
                            </div>

                            <div class="lg:col-span-2">
                                <div class="flex items-center space-x-3 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                    <input type="checkbox" name="tts_use_speaker_boost" id="tts_use_speaker_boost"
                                        {% if not assistant or (assistant.tts_settings and assistant.tts_settings.use_speaker_boost) %}checked{% endif %}
                                        class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-offset-gray-800">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2">
                                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                            </svg>
                                            <label for="tts_use_speaker_boost" class="text-sm font-medium text-white">Enhanced Audio Quality</label>
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-500/20 text-green-400">
                                                🔥 Recommended
                                            </span>
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">Boosts voice clarity and reduces background noise. Perfect for phone calls and noisy environments.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STT Tab Content -->
                    <div id="stt-content" class="ai-tab-content hidden p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label for="stt_model" class="block text-sm font-medium text-gray-300 mb-2">Model</label>
                                <select name="stt_model" id="stt_model"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="nova-3" {% if assistant and assistant.stt_settings and assistant.stt_settings.model == 'nova-3' %}selected{% endif %}>Nova-3 (Latest - Keyterms Support)</option>
                                    <option value="nova-2" {% if assistant and assistant.stt_settings and assistant.stt_settings.model == 'nova-2' %}selected{% endif %}>Nova-2 (Keywords Support)</option>
                                    <option value="nova" {% if assistant and assistant.stt_settings and assistant.stt_settings.model == 'nova' %}selected{% endif %}>Nova (Keywords Support)</option>
                                    <option value="enhanced" {% if assistant and assistant.stt_settings and assistant.stt_settings.model == 'enhanced' %}selected{% endif %}>Enhanced (Keywords Support)</option>
                                    <option value="base" {% if assistant and assistant.stt_settings and assistant.stt_settings.model == 'base' %}selected{% endif %}>Base (Keywords Support)</option>
                                </select>
                            </div>

                            <div>
                                <label for="stt_language" class="block text-sm font-medium text-gray-300 mb-2">Language</label>
                                <select name="stt_language" id="stt_language"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                    <option value="en-US" {% if assistant and assistant.stt_settings and assistant.stt_settings.language == 'en-US' %}selected{% endif %}>English (US)</option>
                                    <option value="en-GB" {% if assistant and assistant.stt_settings and assistant.stt_settings.language == 'en-GB' %}selected{% endif %}>English (UK)</option>
                                    <option value="en-AU" {% if assistant and assistant.stt_settings and assistant.stt_settings.language == 'en-AU' %}selected{% endif %}>English (Australia)</option>
                                    <option value="custom">Custom Language Code</option>
                                </select>
                                <div id="custom_language_container" class="mt-3 hidden">
                                    <input type="text" id="custom_language" placeholder="Enter language code (e.g., fr-FR)"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                            </div>

                            <!-- Timing Settings -->
                            <div>
                                <label for="stt_silence_threshold" class="block text-sm font-medium text-gray-300 mb-2">Silence Threshold (ms)</label>
                                <input type="number" name="stt_silence_threshold" id="stt_silence_threshold"
                                    value="{{ assistant.stt_settings.endpointing.silence_threshold if assistant and assistant.stt_settings and assistant.stt_settings.endpointing else 500 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>

                            <div>
                                <label for="stt_min_silence_duration" class="block text-sm font-medium text-gray-300 mb-2">Min Silence Duration (ms)</label>
                                <input type="number" name="stt_min_silence_duration" id="stt_min_silence_duration"
                                    value="{{ assistant.stt_settings.endpointing.min_silence_duration if assistant and assistant.stt_settings and assistant.stt_settings.endpointing else 500 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>

                            <div>
                                <label for="stt_utterance_end_ms" class="block text-sm font-medium text-gray-300 mb-2">Utterance End (ms)</label>
                                <input type="number" name="stt_utterance_end_ms" id="stt_utterance_end_ms"
                                    value="{{ assistant.stt_settings.utterance_end_ms if assistant and assistant.stt_settings else 1000 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>

                            <div>
                                <label for="stt_vad_turnoff" class="block text-sm font-medium text-gray-300 mb-2">VAD Turnoff (ms)</label>
                                <input type="number" name="stt_vad_turnoff" id="stt_vad_turnoff"
                                    value="{{ assistant.stt_settings.vad_turnoff if assistant and assistant.stt_settings else 500 }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                            </div>

                            <!-- Processing Options -->
                            <div class="lg:col-span-2">
                                <h4 class="text-sm font-medium text-gray-300 mb-4">Processing Options</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" name="stt_punctuate" id="stt_punctuate"
                                            {% if not assistant or (assistant.stt_settings and assistant.stt_settings.punctuate) %}checked{% endif %}
                                            class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-offset-gray-800">
                                        <label for="stt_punctuate" class="text-sm text-white">Add Punctuation</label>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" name="stt_interim_results" id="stt_interim_results"
                                            {% if not assistant or (assistant.stt_settings and assistant.stt_settings.interim_results) %}checked{% endif %}
                                            class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-offset-gray-800">
                                        <label for="stt_interim_results" class="text-sm text-white">Interim Results</label>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" name="stt_smart_format" id="stt_smart_format"
                                            {% if not assistant or (assistant.stt_settings and assistant.stt_settings.smart_format) %}checked{% endif %}
                                            class="w-5 h-5 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-offset-gray-800">
                                        <label for="stt_smart_format" class="text-sm text-white">Smart Format</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Keywords and Keyterms -->
                            <div class="lg:col-span-2 border-t border-gray-700/50 pt-6">
                                <h4 class="text-sm font-medium text-gray-300 mb-4">Keywords & Keyterms Enhancement</h4>
                                <div class="space-y-6">
                                    <!-- Keywords -->
                                    <div id="keywords-section">
                                        <label for="stt_keywords" class="block text-sm font-medium text-gray-300 mb-2">
                                            Keywords <span class="text-gray-500">(Nova-2, Nova-1, Enhanced, Base models)</span>
                                        </label>
                                        <textarea id="stt_keywords" name="stt_keywords" rows="3"
                                            class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                            placeholder="OpenAI:2.0, ChatGPT:1.5, API, machine learning:1.8">{% if assistant and assistant.stt_settings and assistant.stt_settings.keywords %}{% for keyword in assistant.stt_settings.keywords %}{% if keyword is mapping %}{{ keyword.keyword }}{% if keyword.intensifier != 1.0 %}:{{ keyword.intensifier }}{% endif %}{% else %}{{ keyword }}{% endif %}{% if not loop.last %}, {% endif %}{% endfor %}{% endif %}</textarea>
                                        <div class="mt-2 p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
                                            <p class="text-xs text-blue-200">
                                                <strong>Example:</strong> Deepgram:2.0, API:1.5, speech recognition, transcription
                                            </p>
                                        </div>
                                    </div>

                                    <!-- Keyterms -->
                                    <div id="keyterms-section">
                                        <label for="stt_keyterms" class="block text-sm font-medium text-gray-300 mb-2">
                                            Keyterms <span class="text-gray-500">(Nova-3 model only, English language)</span>
                                        </label>
                                        <textarea id="stt_keyterms" name="stt_keyterms" rows="3"
                                            class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                            placeholder="artificial intelligence, machine learning, neural networks, customer service">{% if assistant and assistant.stt_settings and assistant.stt_settings.keyterms %}{{ assistant.stt_settings.keyterms | join(', ') }}{% endif %}</textarea>
                                        <div class="mt-2 p-3 bg-green-500/10 border border-green-500/20 rounded-lg">
                                            <p class="text-xs text-green-200">
                                                <strong>Example:</strong> artificial intelligence, machine learning, customer service, technical support
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Call Management -->
            <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-green-500/10 to-teal-500/10 border-b border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">Call Management</h3>
                                <p class="text-gray-400 text-sm">Configure call behavior and interruption handling</p>
                            </div>
                        </div>
                        <button type="button" onclick="toggleCallManagement()" class="text-green-400 hover:text-green-300 text-sm font-medium transition-colors">
                            <span id="call-toggle-text">Configure</span>
                        </button>
                    </div>
                </div>
                <div id="call-management" class="hidden p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Interruption Settings -->
                        <div>
                            <h4 class="text-base font-semibold text-white mb-4">Interruption Settings</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="interruption_threshold" class="block text-sm font-medium text-gray-300 mb-2">Interruption Threshold (words)</label>
                                    <input type="number" name="interruption_threshold" id="interruption_threshold"
                                        value="{{ assistant.interruption_settings.interruption_threshold if assistant and assistant.interruption_settings else 3 }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                                <div>
                                    <label for="min_speaking_time" class="block text-sm font-medium text-gray-300 mb-2">Min Speaking Time (seconds)</label>
                                    <input type="number" step="0.1" name="min_speaking_time" id="min_speaking_time"
                                        value="{{ assistant.interruption_settings.min_speaking_time if assistant and assistant.interruption_settings else 0.5 }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                                <div>
                                    <label for="interruption_cooldown" class="block text-sm font-medium text-gray-300 mb-2">Interruption Cooldown (seconds)</label>
                                    <input type="number" step="0.1" name="interruption_cooldown" id="interruption_cooldown"
                                        value="{{ assistant.interruption_settings.interruption_cooldown if assistant and assistant.interruption_settings else 2.0 }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                            </div>
                        </div>

                        <!-- Call Control Messages -->
                        <div>
                            <h4 class="text-base font-semibold text-white mb-4">Call Control Messages</h4>
                            <div class="space-y-4">
                                <div>
                                    <label for="end_call_message" class="block text-sm font-medium text-gray-300 mb-2">End Call Message</label>
                                    <input type="text" name="end_call_message" id="end_call_message"
                                        value="{{ assistant.end_call_message if assistant else 'Thank you for calling. Goodbye!' }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Thank you for calling. Goodbye!">
                                </div>
                                <div>
                                    <label for="transfer_call_message" class="block text-sm font-medium text-gray-300 mb-2">Transfer Call Message</label>
                                    <input type="text" name="transfer_call_message" id="transfer_call_message"
                                        value="{{ assistant.transfer_call_message if assistant else 'Please hold while I transfer your call.' }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Please hold while I transfer your call.">
                                </div>
                                <div>
                                    <label for="idle_message" class="block text-sm font-medium text-gray-300 mb-2">Idle Message</label>
                                    <input type="text" name="idle_message" id="idle_message"
                                        value="{{ assistant.idle_message if assistant else 'Are you still there? I\'m here to help if you need anything.' }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="Are you still there? I'm here to help if you need anything.">
                                    <p class="mt-2 text-xs text-gray-400">Message sent when no activity is detected during a call</p>
                                </div>
                            </div>
                        </div>

                        <!-- Timeout Settings -->
                        <div class="lg:col-span-2">
                            <h4 class="text-base font-semibold text-white mb-4">Timeout Settings</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="max_idle_messages" class="block text-sm font-medium text-gray-300 mb-2">Max Idle Messages</label>
                                    <input type="number" name="max_idle_messages" id="max_idle_messages"
                                        value="{{ assistant.max_idle_messages if assistant else 3 }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                                <div>
                                    <label for="idle_timeout" class="block text-sm font-medium text-gray-300 mb-2">Idle Timeout (seconds)</label>
                                    <input type="number" name="idle_timeout" id="idle_timeout"
                                        value="{{ assistant.idle_timeout if assistant else 30 }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Integration Settings -->
            <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-orange-500/10 to-red-500/10 border-b border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">Integration Settings</h3>
                                <p class="text-gray-400 text-sm">API keys and webhook configuration</p>
                            </div>
                        </div>
                        <button type="button" onclick="toggleIntegration()" class="text-orange-400 hover:text-orange-300 text-sm font-medium transition-colors">
                            <span id="integration-toggle-text">Configure</span>
                        </button>
                    </div>
                </div>
                <div id="integration-settings" class="hidden p-6">
                    <div class="space-y-8">
                        <!-- API Keys -->
                        <div>
                            <h4 class="text-base font-semibold text-white mb-4">API Keys <span class="text-gray-400 text-sm font-normal">(Optional - System defaults will be used if not provided)</span></h4>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="relative">
                                    <label for="openai_api_key" class="block text-sm font-medium text-gray-300 mb-2">OpenAI API Key</label>
                                    <input type="password" name="openai_api_key" id="openai_api_key"
                                        value="{{ assistant.openai_api_key if assistant and assistant.openai_api_key else '' }}"
                                        class="block w-full px-4 py-3 pr-12 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="sk-...">
                                    <button type="button" onclick="togglePassword('openai_api_key')" class="absolute right-3 top-9 text-gray-400 hover:text-gray-300">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>

                                <div class="relative">
                                    <label for="deepgram_api_key" class="block text-sm font-medium text-gray-300 mb-2">Deepgram API Key</label>
                                    <input type="password" name="deepgram_api_key" id="deepgram_api_key"
                                        value="{{ assistant.deepgram_api_key if assistant and assistant.deepgram_api_key else '' }}"
                                        class="block w-full px-4 py-3 pr-12 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="sk-...">
                                    <button type="button" onclick="togglePassword('deepgram_api_key')" class="absolute right-3 top-9 text-gray-400 hover:text-gray-300">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>

                                <div class="relative">
                                    <label for="elevenlabs_api_key" class="block text-sm font-medium text-gray-300 mb-2">ElevenLabs API Key</label>
                                    <input type="password" name="elevenlabs_api_key" id="elevenlabs_api_key"
                                        value="{{ assistant.elevenlabs_api_key if assistant and assistant.elevenlabs_api_key else '' }}"
                                        class="block w-full px-4 py-3 pr-12 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="sk-...">
                                    <button type="button" onclick="togglePassword('elevenlabs_api_key')" class="absolute right-3 top-9 text-gray-400 hover:text-gray-300">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>

                                <div>
                                    <label for="twilio_account_sid" class="block text-sm font-medium text-gray-300 mb-2">Twilio Account SID</label>
                                    <input type="password" name="twilio_account_sid" id="twilio_account_sid"
                                        value="{{ assistant.twilio_account_sid if assistant and assistant.twilio_account_sid else '' }}"
                                        class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="AC...">
                                </div>

                                <div class="relative">
                                    <label for="twilio_auth_token" class="block text-sm font-medium text-gray-300 mb-2">Twilio Auth Token</label>
                                    <input type="password" name="twilio_auth_token" id="twilio_auth_token"
                                        value="{{ assistant.twilio_auth_token if assistant and assistant.twilio_auth_token else '' }}"
                                        class="block w-full px-4 py-3 pr-12 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        placeholder="...">
                                    <button type="button" onclick="togglePassword('twilio_auth_token')" class="absolute right-3 top-9 text-gray-400 hover:text-gray-300">
                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Configuration -->
                        <div>
                            <h4 class="text-base font-semibold text-white mb-4">Webhook Configuration</h4>
                            <div>
                                <label for="webhook_url" class="block text-sm font-medium text-gray-300 mb-2">Webhook URL</label>
                                <input type="url" name="webhook_url" id="webhook_url"
                                    value="{{ assistant.webhook_url if assistant else '' }}"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="https://your-app.com/webhook">
                                <p class="mt-2 text-xs text-gray-400">
                                    If provided, webhooks will be sent for call status updates and end-of-call reports
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Advanced Settings -->
            <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 border-b border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">Advanced Settings</h3>
                                <p class="text-gray-400 text-sm">Structured data extraction and custom configurations</p>
                            </div>
                        </div>
                        <button type="button" onclick="toggleAdvanced()" class="text-purple-400 hover:text-purple-300 text-sm font-medium transition-colors">
                            <span id="advanced-toggle-text">Configure</span>
                        </button>
                    </div>
                </div>
                <div id="advanced-settings" class="hidden p-6">
                    <div class="space-y-6">
                        <!-- Structured Data Extraction Builder -->
                        <div>
                            <div class="flex items-center space-x-3 mb-6">
                                <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <div>
                                    <h4 class="text-base font-semibold text-white">Smart Data Extraction Builder</h4>
                                    <p class="text-sm text-gray-400">Tell us what information you want to extract from calls, and we'll handle the technical setup</p>
                                </div>
                            </div>

                            <!-- Simple Field Builder -->
                            <div class="bg-gray-700/30 border border-gray-600/50 rounded-lg p-6 mb-6">
                                <div class="flex items-center justify-between mb-4">
                                    <h5 class="text-sm font-medium text-white">What information do you want to capture from calls?</h5>
                                    <button type="button" onclick="addDataField()" class="inline-flex items-center px-3 py-2 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Add Field
                                    </button>
                                </div>

                                <!-- Dynamic Fields Container -->
                                <div id="data-fields-container" class="space-y-4">
                                    <!-- Default fields will be added here by JavaScript -->
                                </div>

                                <!-- Popular Templates -->
                                <div class="mt-6 pt-6 border-t border-gray-600/50">
                                    <h6 class="text-sm font-medium text-gray-300 mb-3">Quick Templates:</h6>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" onclick="loadTemplate('sales')" class="px-3 py-1 text-xs text-blue-300 bg-blue-500/20 hover:bg-blue-500/30 rounded-full border border-blue-500/30 transition-colors">
                                            🛒 Sales Call
                                        </button>
                                        <button type="button" onclick="loadTemplate('support')" class="px-3 py-1 text-xs text-green-300 bg-green-500/20 hover:bg-green-500/30 rounded-full border border-green-500/30 transition-colors">
                                            🛠️ Customer Support
                                        </button>
                                        <button type="button" onclick="loadTemplate('booking')" class="px-3 py-1 text-xs text-purple-300 bg-purple-500/20 hover:bg-purple-500/30 rounded-full border border-purple-500/30 transition-colors">
                                            📅 Appointment Booking
                                        </button>
                                        <button type="button" onclick="loadTemplate('feedback')" class="px-3 py-1 text-xs text-orange-300 bg-orange-500/20 hover:bg-orange-500/30 rounded-full border border-orange-500/30 transition-colors">
                                            💬 Feedback Collection
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Custom Extraction Prompt -->
                            <div class="bg-gray-700/30 border border-gray-600/50 rounded-lg p-6">
                                <div class="flex items-center space-x-2 mb-4">
                                    <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                    <h5 class="text-sm font-medium text-white">Custom Instructions</h5>
                                    <span class="text-xs text-gray-500 italic">Optional</span>
                                    <div class="group relative">
                                        <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <div class="hidden group-hover:block absolute z-20 w-80 p-4 mt-1 text-sm text-white bg-gray-800 border border-gray-600 rounded-lg shadow-xl -left-1/2">
                                            <div class="font-semibold mb-2">Additional Context for AI 🤖</div>
                                            <div class="text-xs">
                                                Provide extra guidance for the AI about your business context, specific terminology, or special instructions for data extraction.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <textarea id="structured_data_prompt" name="structured_data_prompt" rows="4"
                                    class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                    placeholder="Add any specific instructions for your business context...">{{ assistant.custom_settings.structured_data_prompt if assistant and assistant.custom_settings and assistant.custom_settings.get('structured_data_prompt') else '' }}</textarea>
                                <div class="mt-2 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                                    <div class="text-xs text-yellow-200">
                                        <strong>💡 Example:</strong> "Focus on identifying customer urgency levels and any specific product mentions. Our main products are X, Y, and Z."
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden JSON Schema (auto-generated) -->
                            <input type="hidden" id="structured_data_schema" name="structured_data_schema" value="">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-between">
                <a href="/assistants" class="px-6 py-3 text-sm font-medium text-gray-300 hover:text-white bg-gray-700/50 hover:bg-gray-600/50 rounded-lg border border-gray-600 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="px-8 py-3 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                    {% if assistant %}Update Assistant{% else %}Create Assistant{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Section toggle functions
function toggleAIConfig() {
    const section = document.getElementById('ai-configuration');
    const toggle = document.getElementById('ai-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

function toggleCallManagement() {
    const section = document.getElementById('call-management');
    const toggle = document.getElementById('call-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

function toggleIntegration() {
    const section = document.getElementById('integration-settings');
    const toggle = document.getElementById('integration-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

function toggleAdvanced() {
    const section = document.getElementById('advanced-settings');
    const toggle = document.getElementById('advanced-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

// AI Configuration tab switching
function switchAITab(tab) {
    // Hide all tab contents
    document.querySelectorAll('.ai-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.ai-tab').forEach(tabButton => {
        tabButton.classList.remove('border-blue-500', 'text-blue-400');
        tabButton.classList.add('border-transparent', 'text-gray-400');
    });
    
    // Show selected tab content
    document.getElementById(tab + '-content').classList.remove('hidden');
    
    // Add active class to selected tab
    const activeTab = document.getElementById(tab + '-tab');
    activeTab.classList.remove('border-transparent', 'text-gray-400');
    activeTab.classList.add('border-blue-500', 'text-blue-400');
}

// Password toggle function
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Example functions
function useExamplePrompt() {
    const textarea = document.getElementById('structured_data_prompt');
    const examplePrompt = "You are an expert sales assistant analyzing customer calls. Extract key information from the conversation.\n\nFocus on:\n- Customer intent and needs\n- Products mentioned\n- Any commitments made\n- Follow-up actions required\n\nCall Summary: {summary}";
    textarea.value = examplePrompt;
}

function useExampleSchema() {
    const textarea = document.getElementById('structured_data_schema');
    const exampleSchema = {
        "type": "object",
        "properties": {
            "chat_topic": {
                "type": "string",
                "description": "The main topic of the conversation"
            },
            "followup_sms": {
                "type": "string", 
                "description": "A follow-up SMS message to send to the customer"
            },
            "order_created": {
                "type": "boolean",
                "description": "Whether an order was successfully created"
            }
        },
        "required": ["chat_topic"]
    };
    textarea.value = JSON.stringify(exampleSchema, null, 2);
}

// Data Field Builder Functions
let fieldCounter = 0;

function addDataField(fieldData = null) {
    fieldCounter++;
    const container = document.getElementById('data-fields-container');
    const fieldId = fieldData ? fieldData.name.replace(/\s+/g, '_').toLowerCase() : `field_${fieldCounter}`;
    
    const fieldHtml = `
        <div class="data-field bg-gray-600/30 border border-gray-500/50 rounded-lg p-4" data-field-id="${fieldId}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-300 mb-1">Field Name</label>
                    <input type="text" class="field-name block w-full px-3 py-2 text-sm bg-gray-700/50 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                           placeholder="e.g., Customer Name" value="${fieldData ? fieldData.name : ''}" onchange="updateSchema()">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-300 mb-1">Data Type</label>
                    <select class="field-type block w-full px-3 py-2 text-sm bg-gray-700/50 border border-gray-600 rounded text-white focus:outline-none focus:ring-1 focus:ring-blue-500" onchange="toggleEnumOptions(this); updateSchema()">
                        <option value="string" ${fieldData && fieldData.type === 'string' ? 'selected' : ''}>📝 Text</option>
                        <option value="number" ${fieldData && fieldData.type === 'number' ? 'selected' : ''}>🔢 Number</option>
                        <option value="boolean" ${fieldData && fieldData.type === 'boolean' ? 'selected' : ''}>✅ Yes/No</option>
                        <option value="array" ${fieldData && fieldData.type === 'array' ? 'selected' : ''}>📋 List</option>
                        <option value="enum" ${fieldData && fieldData.type === 'enum' ? 'selected' : ''}>📋 Multiple Choice</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="removeDataField('${fieldId}')" class="w-full px-3 py-2 text-xs text-red-300 hover:text-red-200 bg-red-500/20 hover:bg-red-500/30 border border-red-500/30 rounded transition-colors">
                        🗑️ Remove
                    </button>
                </div>
            </div>
            <div class="mt-3">
                <label class="block text-xs font-medium text-gray-300 mb-1">Description (helps AI understand what to look for)</label>
                <input type="text" class="field-description block w-full px-3 py-2 text-sm bg-gray-700/50 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                       placeholder="e.g., The customer's full name as mentioned in the call" value="${fieldData ? fieldData.description : ''}" onchange="updateSchema()">
            </div>
            
            <!-- Enum Options Container -->
            <div class="enum-options mt-3 ${fieldData && fieldData.type === 'enum' ? '' : 'hidden'}">
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-xs font-medium text-gray-300">Available Options</label>
                    <button type="button" onclick="addEnumOption('${fieldId}')" class="px-2 py-1 text-xs text-blue-300 bg-blue-500/20 hover:bg-blue-500/30 rounded border border-blue-500/30 transition-colors">
                        + Add Option
                    </button>
                </div>
                <div class="enum-values space-y-2">
                    ${fieldData && fieldData.enum ? fieldData.enum.map((option, index) => `
                        <div class="flex items-center space-x-2">
                            <input type="text" class="enum-value flex-1 px-2 py-1 text-xs bg-gray-700/50 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                   value="${option}" placeholder="Option value" onchange="updateSchema()">
                            <button type="button" onclick="removeEnumOption(this)" class="px-2 py-1 text-xs text-red-300 hover:text-red-200 bg-red-500/20 hover:bg-red-500/30 rounded">✕</button>
                        </div>
                    `).join('') : `
                        <div class="flex items-center space-x-2">
                            <input type="text" class="enum-value flex-1 px-2 py-1 text-xs bg-gray-700/50 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                   placeholder="Option 1" onchange="updateSchema()">
                            <button type="button" onclick="removeEnumOption(this)" class="px-2 py-1 text-xs text-red-300 hover:text-red-200 bg-red-500/20 hover:bg-red-500/30 rounded">✕</button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="text" class="enum-value flex-1 px-2 py-1 text-xs bg-gray-700/50 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                                   placeholder="Option 2" onchange="updateSchema()">
                            <button type="button" onclick="removeEnumOption(this)" class="px-2 py-1 text-xs text-red-300 hover:text-red-200 bg-red-500/20 hover:bg-red-500/30 rounded">✕</button>
                        </div>
                    `}
                </div>
                <p class="text-xs text-gray-400 mt-2">AI will choose one of these exact options</p>
            </div>
            
            <div class="mt-2 flex items-center">
                <input type="checkbox" class="field-required w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-500" 
                       ${fieldData && fieldData.required ? 'checked' : ''} onchange="updateSchema()">
                <label class="ml-2 text-xs text-gray-300">Required field</label>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', fieldHtml);
    updateSchema();
}

function removeDataField(fieldId) {
    const field = document.querySelector(`[data-field-id="${fieldId}"]`);
    if (field) {
        field.remove();
        updateSchema();
    }
}

function updateSchema() {
    const fields = document.querySelectorAll('.data-field');
    const schema = {
        type: "object",
        properties: {},
        required: []
    };
    
    fields.forEach(field => {
        const name = field.querySelector('.field-name').value.trim();
        const type = field.querySelector('.field-type').value;
        const description = field.querySelector('.field-description').value.trim();
        const required = field.querySelector('.field-required').checked;
        
        if (name) {
            const fieldKey = name.replace(/\s+/g, '_').toLowerCase();
            
            if (type === 'enum') {
                // Handle enum type
                const enumValues = Array.from(field.querySelectorAll('.enum-value'))
                    .map(input => input.value.trim())
                    .filter(value => value.length > 0);
                
                if (enumValues.length > 0) {
                    schema.properties[fieldKey] = {
                        type: "string",
                        enum: enumValues,
                        description: description || `The ${name.toLowerCase()} from the conversation (one of: ${enumValues.join(', ')})`
                    };
                }
            } else {
                // Handle other types
                schema.properties[fieldKey] = {
                    type: type,
                    description: description || `The ${name.toLowerCase()} from the conversation`
                };
                
                // Special handling for array type
                if (type === 'array') {
                    schema.properties[fieldKey].items = {
                        type: "string"
                    };
                }
            }
            
            if (required && schema.properties[fieldKey]) {
                schema.required.push(fieldKey);
            }
        }
    });
    
    document.getElementById('structured_data_schema').value = JSON.stringify(schema, null, 2);
}

function loadTemplate(templateType) {
    // Clear existing fields
    document.getElementById('data-fields-container').innerHTML = '';
    fieldCounter = 0;
    
    const templates = {
        sales: [
            { name: "Customer Name", type: "string", description: "The customer's full name", required: true },
            { name: "Product Interest", type: "string", description: "Which product or service the customer is interested in", required: true },
            { name: "Budget Range", type: "enum", description: "The customer's mentioned budget range", required: false, enum: ["Under $1,000", "$1,000-$5,000", "$5,000-$10,000", "$10,000+", "Budget not discussed"] },
            { name: "Purchase Intent", type: "enum", description: "How likely the customer is to purchase", required: false, enum: ["High", "Medium", "Low", "Not specified"] },
            { name: "Follow-up Required", type: "boolean", description: "Whether a follow-up call or action is needed", required: false },
            { name: "Contact Method", type: "enum", description: "Preferred way to contact the customer", required: false, enum: ["Phone", "Email", "Text message", "In-person", "Not specified"] }
        ],
        support: [
            { name: "Issue Type", type: "enum", description: "The main category of the customer's problem", required: true, enum: ["Technical", "Billing", "Account", "Product", "Service", "Other"] },
            { name: "Issue Description", type: "string", description: "Detailed description of the problem", required: true },
            { name: "Customer Urgency", type: "enum", description: "How urgent the issue is", required: false, enum: ["Critical", "High", "Medium", "Low"] },
            { name: "Resolution Status", type: "enum", description: "Was the issue resolved during the call", required: false, enum: ["Resolved", "Partially resolved", "Escalated", "Unresolved"] },
            { name: "Escalation Needed", type: "boolean", description: "Does this need to be escalated to a specialist", required: false },
            { name: "Customer Satisfaction", type: "enum", description: "How satisfied the customer seemed", required: false, enum: ["Very satisfied", "Satisfied", "Neutral", "Dissatisfied", "Very dissatisfied"] }
        ],
        booking: [
            { name: "Service Type", type: "string", description: "What service or appointment they want to book", required: true },
            { name: "Preferred Date", type: "string", description: "Customer's preferred appointment date", required: false },
            { name: "Preferred Time", type: "enum", description: "Customer's preferred time slot", required: false, enum: ["Morning (9AM-12PM)", "Afternoon (12PM-5PM)", "Evening (5PM-8PM)", "Flexible", "Not specified"] },
            { name: "Duration Needed", type: "enum", description: "How long the appointment should be", required: false, enum: ["30 minutes", "1 hour", "2 hours", "Half day", "Full day", "Multiple days"] },
            { name: "Special Requirements", type: "string", description: "Any special needs or requests", required: false },
            { name: "Booking Confirmed", type: "boolean", description: "Was the appointment successfully booked", required: false }
        ],
        feedback: [
            { name: "Overall Rating", type: "enum", description: "Customer's overall rating or satisfaction score", required: false, enum: ["1 - Very Poor", "2 - Poor", "3 - Average", "4 - Good", "5 - Excellent"] },
            { name: "Positive Feedback", type: "string", description: "What the customer liked or appreciated", required: false },
            { name: "Areas for Improvement", type: "string", description: "What could be improved according to the customer", required: false },
            { name: "Specific Complaints", type: "string", description: "Any specific issues or complaints mentioned", required: false },
            { name: "Recommendation Likelihood", type: "enum", description: "How likely customer is to recommend us", required: false, enum: ["Very likely", "Likely", "Neutral", "Unlikely", "Very unlikely"] },
            { name: "Follow-up Requested", type: "boolean", description: "Did customer request someone to follow up", required: false }
        ]
    };
    
    if (templates[templateType]) {
        templates[templateType].forEach(field => {
            addDataField(field);
        });
    }
}

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    // Initialize data extraction builder
    initializeDataFields();
    
    // Initialize LLM provider options
    updateProviderOptions();
    
    // Handle STT model changes for keywords/keyterms visibility
    const sttModelSelect = document.getElementById('stt_model');
    const keywordsSection = document.getElementById('keywords-section');
    const keytermsSection = document.getElementById('keyterms-section');
    
    function updateKeywordVisibility() {
        const selectedModel = sttModelSelect.value;
        const keywordSupportedModels = ['nova-2', 'nova-1', 'enhanced', 'base'];
        const keytermSupportedModels = ['nova-3'];
        
        // Show/hide keywords based on model
        if (keywordSupportedModels.includes(selectedModel)) {
            keywordsSection.style.display = 'block';
        } else {
            keywordsSection.style.display = 'none';
        }
        
        // Show/hide keyterms based on model
        if (keytermSupportedModels.includes(selectedModel)) {
            keytermsSection.style.display = 'block';
        } else {
            keytermsSection.style.display = 'none';
        }
    }
    
    // Initialize visibility on page load
    if (sttModelSelect) {
        updateKeywordVisibility();
        sttModelSelect.addEventListener('change', updateKeywordVisibility);
    }

    // Handle custom inputs
    const customInputs = {
        'llm_model': 'custom_llm_model_container',
        'tts_voice_id': 'custom_voice_container',
        'stt_language': 'custom_language_container',
        'phone_number': 'custom_phone_container'
    };

    Object.entries(customInputs).forEach(([selectId, containerId]) => {
        const select = document.getElementById(selectId);
        const container = document.getElementById(containerId);
        if (select && container) {
            // Check if current value is custom
            const customInput = container.querySelector('input');
            if (customInput && customInput.value && !select.querySelector(`option[value="${customInput.value}"]`)) {
                select.value = 'custom';
                container.classList.remove('hidden');
                customInput.name = selectId;
                select.name = `_${selectId}_dropdown`;
            }

            select.addEventListener('change', function() {
                if (this.value === 'custom') {
                    container.classList.remove('hidden');
                    const customInput = container.querySelector('input');
                    if (customInput) {
                        customInput.name = selectId;
                        this.name = `_${selectId}_dropdown`;
                    }
                } else {
                    container.classList.add('hidden');
                    const customInput = container.querySelector('input');
                    if (customInput) {
                        customInput.name = `_custom_${selectId}`;
                        this.name = selectId;
                    }
                }
            });
        }
    });
});

// LLM Provider management functions
function updateProviderOptions() {
    const provider = document.getElementById('llm_provider').value;
    const modelSelect = document.getElementById('llm_provider_model');
    const apiKeyHelp = document.getElementById('api-key-help');
    const baseUrlContainer = document.getElementById('base-url-container');
    const baseUrlHelp = document.getElementById('base-url-help');
    const modelHelpContent = document.getElementById('model-help-content');
    
    // Clear existing options
    modelSelect.innerHTML = '';
    
    // Provider-specific configurations
    const providerConfigs = {
        openai: {
            models: [
                { value: 'gpt-4o', label: '🚀 GPT-4o (Most Advanced)' },
                { value: 'gpt-4o-mini', label: '⚡ GPT-4o Mini (Fast & Efficient)' },
                { value: 'gpt-3.5-turbo', label: '💰 GPT-3.5 Turbo (Cost Effective)' }
            ],
            apiKeyHelp: 'Enter your OpenAI API key from platform.openai.com',
            showBaseUrl: false,
            baseUrlHelp: '',
            modelHelp: [
                '<div><strong>GPT-4o:</strong> Most advanced, best for complex conversations</div>',
                '<div><strong>GPT-4o-mini:</strong> Faster and cheaper, good balance</div>',
                '<div><strong>GPT-3.5-turbo:</strong> Fast and cost-effective for simple tasks</div>'
            ]
        },
        anthropic: {
            models: [
                { value: 'claude-3-5-sonnet-latest', label: '🧠 Claude 3.5 Sonnet (Recommended)' },
                { value: 'claude-3-haiku-20240307', label: '⚡ Claude 3 Haiku (Fast)' }
            ],
            apiKeyHelp: 'Enter your Anthropic API key from console.anthropic.com',
            showBaseUrl: false,
            baseUrlHelp: '',
            modelHelp: [
                '<div><strong>Claude 3.5 Sonnet:</strong> Advanced reasoning and safety</div>',
                '<div><strong>Claude 3 Haiku:</strong> Fast and efficient</div>'
            ]
        },
        gemini: {
            models: [
                { value: 'gemini-2.0-flash', label: '🌟 Gemini 2.0 Flash (Latest)' },
                { value: 'gemini-1.5-pro', label: '⭐ Gemini 1.5 Pro' }
            ],
            apiKeyHelp: 'Enter your Google AI API key from aistudio.google.com',
            showBaseUrl: true,
            baseUrlHelp: 'Google Gemini OpenAI-compatible endpoint (auto-filled)',
            modelHelp: [
                '<div><strong>Gemini 2.0 Flash:</strong> Latest Google model with multimodal capabilities</div>',
                '<div><strong>Gemini 1.5 Pro:</strong> Powerful reasoning and long context</div>'
            ]
        },
        xai: {
            models: [
                { value: 'grok-beta', label: '⚡ Grok Beta (Recommended)' },
                { value: 'grok-2-1212', label: '🚀 Grok 2 (Latest)' }
            ],
            apiKeyHelp: 'Enter your xAI API key from console.x.ai',
            showBaseUrl: true,
            baseUrlHelp: 'xAI API endpoint (auto-filled)',
            modelHelp: [
                '<div><strong>Grok Beta:</strong> Real-time information and less restrictive</div>',
                '<div><strong>Grok 2:</strong> Latest and most capable Grok model</div>'
            ]
        },
        groq: {
            models: [
                { value: 'llama-3.3-70b-versatile', label: '🔥 Llama 3.3 70B (Recommended)' },
                { value: 'llama-3.1-8b-instant', label: '⚡ Llama 3.1 8B (Ultra Fast)' }
            ],
            apiKeyHelp: 'Enter your Groq API key from console.groq.com',
            showBaseUrl: false,
            baseUrlHelp: '',
            modelHelp: [
                '<div><strong>Llama 3.3 70B:</strong> High quality with ultra-fast inference</div>',
                '<div><strong>Llama 3.1 8B:</strong> Extremely fast for simple tasks</div>'
            ]
        },
        custom: {
            models: [
                { value: '', label: 'Enter custom model name' }
            ],
            apiKeyHelp: 'Enter API key if required by your custom endpoint',
            showBaseUrl: true,
            baseUrlHelp: 'Your custom API endpoint URL (e.g., https://api.yourservice.com/v1)',
            modelHelp: [
                '<div><strong>Custom Model:</strong> Specify your model name or leave blank</div>'
            ]
        }
    };
    
    const config = providerConfigs[provider] || providerConfigs.openai;
    
    // Populate model options
    config.models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = model.label;
        modelSelect.appendChild(option);
    });
    
    // Set selected model if editing existing assistant
    if (ASSISTANT_DATA.model && ASSISTANT_DATA.provider === provider) {
        const currentModel = ASSISTANT_DATA.model;
        if (modelSelect.querySelector(`option[value="${currentModel}"]`)) {
            modelSelect.value = currentModel;
        }
    }
    
    // Update help text
    apiKeyHelp.textContent = config.apiKeyHelp;
    baseUrlHelp.textContent = config.baseUrlHelp;
    modelHelpContent.innerHTML = config.modelHelp.join('');
    
    // Show/hide base URL field
    if (config.showBaseUrl) {
        baseUrlContainer.classList.remove('hidden');
        // Auto-fill base URL for some providers
        if (provider === 'gemini' && !document.getElementById('llm_provider_base_url').value) {
            document.getElementById('llm_provider_base_url').value = 'https://generativelanguage.googleapis.com/v1beta/openai/';
        } else if (provider === 'xai' && !document.getElementById('llm_provider_base_url').value) {
            document.getElementById('llm_provider_base_url').value = 'https://api.x.ai/v1';
        }
    } else {
        baseUrlContainer.classList.add('hidden');
    }
    
    // For custom provider, make model input text instead of select
    if (provider === 'custom') {
        modelSelect.innerHTML = '<option value="">Enter model name...</option>';
        // Convert to text input
        const modelInput = document.createElement('input');
        modelInput.type = 'text';
        modelInput.name = 'llm_provider_model';
        modelInput.id = 'llm_provider_model';
        modelInput.className = modelSelect.className;
        modelInput.placeholder = 'Enter your custom model name';
        if (ASSISTANT_DATA.provider === 'custom' && ASSISTANT_DATA.model) {
            modelInput.value = ASSISTANT_DATA.model;
        }
        modelSelect.parentNode.replaceChild(modelInput, modelSelect);
    } else {
        // Ensure we have a select element (not text input)
        const currentModelField = document.getElementById('llm_provider_model');
        if (currentModelField.tagName === 'INPUT') {
            const newSelect = document.createElement('select');
            newSelect.name = 'llm_provider_model';
            newSelect.id = 'llm_provider_model';
            newSelect.className = currentModelField.className;
            currentModelField.parentNode.replaceChild(newSelect, currentModelField);
            
            // Re-populate options
            config.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                newSelect.appendChild(option);
            });
            
            // Set selected model if editing existing assistant
            if (ASSISTANT_DATA.model && ASSISTANT_DATA.provider === provider) {
                const currentModel = ASSISTANT_DATA.model;
                if (newSelect.querySelector(`option[value="${currentModel}"]`)) {
                    newSelect.value = currentModel;
                }
            }
        }
    }
}

function initializeDataFields() {
    try {
        // Check if there's existing schema data
        const existingSchema = '{{ (assistant.custom_settings.structured_data_schema | tojson) if assistant and assistant.custom_settings and assistant.custom_settings.get("structured_data_schema") else "{}" }}';
        const schema = JSON.parse(existingSchema.replace(/'/g, '"'));
        
        if (schema && schema.properties && Object.keys(schema.properties).length > 0) {
            // Load existing fields
            Object.entries(schema.properties).forEach(([key, field]) => {
                const fieldData = {
                    name: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    type: field.enum ? 'enum' : field.type || 'string',
                    description: field.description || '',
                    required: schema.required && schema.required.includes(key),
                    enum: field.enum || null
                };
                addDataField(fieldData);
            });
        } else {
            // Add one default field to show users how it works
            addDataField({ 
                name: "Call Topic", 
                type: "string", 
                description: "The main topic or purpose of the call", 
                required: true 
            });
        }
    } catch (e) {
        // If there's an error parsing existing data, just add a default field
        addDataField({ 
            name: "Call Topic", 
            type: "string", 
            description: "The main topic or purpose of the call", 
            required: true 
        });
    }
}

function toggleEnumOptions(selectElement) {
    const fieldContainer = selectElement.closest('.data-field');
    const enumContainer = fieldContainer.querySelector('.enum-options');
    
    if (selectElement.value === 'enum') {
        enumContainer.classList.remove('hidden');
    } else {
        enumContainer.classList.add('hidden');
    }
}

function addEnumOption(fieldId) {
    const field = document.querySelector(`[data-field-id="${fieldId}"]`);
    const enumValues = field.querySelector('.enum-values');
    
    const optionHtml = `
        <div class="flex items-center space-x-2">
            <input type="text" class="enum-value flex-1 px-2 py-1 text-xs bg-gray-700/50 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                   placeholder="New option" onchange="updateSchema()">
            <button type="button" onclick="removeEnumOption(this)" class="px-2 py-1 text-xs text-red-300 hover:text-red-200 bg-red-500/20 hover:bg-red-500/30 rounded">✕</button>
        </div>
    `;
    
    enumValues.insertAdjacentHTML('beforeend', optionHtml);
    updateSchema();
}

function removeEnumOption(button) {
    const optionContainer = button.closest('.flex');
    optionContainer.remove();
    updateSchema();
}

// Template variables
const ASSISTANT_DATA = {
    provider: {% if assistant and assistant.llm_provider %}'{{ assistant.llm_provider }}'{% else %}'openai'{% endif %},
    model: {% if assistant and assistant.llm_provider_config and assistant.llm_provider_config.model %}'{{ assistant.llm_provider_config.model }}'{% else %}null{% endif %},
    apiKey: {% if assistant and assistant.llm_provider_config and assistant.llm_provider_config.api_key %}'{{ assistant.llm_provider_config.api_key }}'{% else %}''{% endif %},
    baseUrl: {% if assistant and assistant.llm_provider_config and assistant.llm_provider_config.base_url %}'{{ assistant.llm_provider_config.base_url }}'{% else %}''{% endif %}
};
</script>
{% endblock %} 
