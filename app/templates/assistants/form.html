{% extends "base.html" %}

{% block title %}
{% if assistant %}Edit Assistant{% else %}Create Assistant{% endif %} - Burki Voice AI
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 p-6">
    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header Section -->
        <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-700 p-8">
            <div class="absolute inset-0 bg-black/20"></div>
            <div class="relative z-10">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-white">
                            {% if assistant %}Edit Assistant: {{ assistant.name }}{% else %}Create New Assistant{% endif %}
                        </h1>
                        <p class="mt-2 text-blue-100">
                            {% if assistant %}Update assistant details and AI configuration.{% else %}Configure your voice AI assistant with advanced settings.{% endif %}
                        </p>
                    </div>
                    <div class="mt-4 lg:mt-0">
                        <a href="/assistants" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-white/10 hover:bg-white/20 rounded-lg border border-white/20 transition-colors">
                            <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Back to Assistants
                        </a>
                    </div>
                </div>
            </div>
            <!-- Decorative background elements -->
            <div class="absolute -bottom-16 -right-16 w-64 h-64 rounded-full bg-white/5 backdrop-blur-sm"></div>
        </div>

        <!-- Progress Indicator -->
        <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-white">Configuration Progress</h2>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                    <span class="text-green-400 text-sm">Ready to Configure</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                        <span class="text-white text-sm font-bold">1</span>
                    </div>
                    <span class="text-gray-300 text-sm">Basic Info</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">2</span>
                    </div>
                    <span class="text-gray-400 text-sm">AI Models</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">3</span>
                    </div>
                    <span class="text-gray-400 text-sm">Call Settings</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">4</span>
                    </div>
                    <span class="text-gray-400 text-sm">Integration</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center">
                        <span class="text-gray-400 text-sm font-bold">5</span>
                    </div>
                    <span class="text-gray-400 text-sm">Advanced</span>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form method="POST" class="space-y-8">
            {% include "assistants/basic_information.html" %}

            <!-- Section 2: AI Configuration -->
            {% include "assistants/ai_configuration.html" %}

            <!-- Section 3: RAG (Knowledge Base) -->
            {% include "assistants/rag.html" %}

            <!-- Section 4: Call Management -->
            {% include "assistants/call_management.html" %}

            <!-- Section 4.5: Tools Configuration -->
            <div class="bg-gray-800/30 backdrop-blur-sm border border-gray-700/50 rounded-xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-emerald-500/10 to-green-500/10 border-b border-gray-700/50">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-white">Tools Configuration</h3>
                                <p class="text-gray-400 text-sm">Enable assistant tools for enhanced call handling</p>
                            </div>
                        </div>
                        <button type="button" onclick="toggleTools()" class="text-emerald-400 hover:text-emerald-300 text-sm font-medium transition-colors">
                            <span id="tools-toggle-text">Configure</span>
                        </button>
                    </div>
                </div>
                <div id="tools-configuration" class="hidden p-6">
                    {% include "assistants/tools_section.html" %}
                </div>
            </div>

            <!-- Section 5: Integration Settings -->
            {% include "assistants/integration_settings.html" %}

            <!-- Section 6: Advanced Settings -->
            {% include "assistants/advanced_settings.html" %}

            <!-- Form Actions -->
            <div class="flex items-center justify-between">
                <a href="/assistants" class="px-6 py-3 text-sm font-medium text-gray-300 hover:text-white bg-gray-700/50 hover:bg-gray-600/50 rounded-lg border border-gray-600 transition-colors">
                    Cancel
                </a>
                <button type="submit" class="px-8 py-3 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                    {% if assistant %}Update Assistant{% else %}Create Assistant{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Section toggle functions
function toggleAIConfig() {
    const section = document.getElementById('ai-configuration');
    const toggle = document.getElementById('ai-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

function toggleCallManagement() {
    const section = document.getElementById('call-management');
    const toggle = document.getElementById('call-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

function toggleIntegration() {
    const section = document.getElementById('integration-settings');
    const toggle = document.getElementById('integration-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

function toggleAdvanced() {
    const section = document.getElementById('advanced-settings');
    const toggle = document.getElementById('advanced-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

// AI Configuration tab switching
function switchAITab(tab) {
    // Hide all tab contents
    document.querySelectorAll('.ai-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.ai-tab').forEach(tabButton => {
        tabButton.classList.remove('border-blue-500', 'text-blue-400');
        tabButton.classList.add('border-transparent', 'text-gray-400');
    });
    
    // Show selected tab content
    document.getElementById(tab + '-content').classList.remove('hidden');
    
    // Add active class to selected tab
    const activeTab = document.getElementById(tab + '-tab');
    activeTab.classList.remove('border-transparent', 'text-gray-400');
    activeTab.classList.add('border-blue-500', 'text-blue-400');
}

// Password toggle function
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Initialize form
document.addEventListener('DOMContentLoaded', function() {
    // Initialize data extraction builder
    initializeDataFields();
    
    // Initialize LLM provider options
    updateProviderOptions();
    
    // Initialize TTS provider options
    updateTTSProviderOptions();
    
    // Add language change listener for Inworld TTS
    const ttsLanguageSelect = document.getElementById('tts_language');
    if (ttsLanguageSelect) {
        ttsLanguageSelect.addEventListener('change', function() {
            const ttsProvider = document.getElementById('tts_provider');
            if (ttsProvider && ttsProvider.value === 'inworld') {
                updateInworldVoices();
            }
        });
    }
    
    // Initialize fallback providers
    initializeFallbackProviders();
    
    // Handle STT model changes for keywords/keyterms visibility
    const sttModelSelect = document.getElementById('stt_model');
    const keywordsSection = document.getElementById('keywords-section');
    const keytermsSection = document.getElementById('keyterms-section');
    
    function updateKeywordVisibility() {
        const selectedModel = sttModelSelect.value;
        const keywordSupportedModels = ['nova-2', 'nova-1', 'enhanced', 'base'];
        const keytermSupportedModels = ['nova-3'];
        
        // Show/hide keywords based on model
        if (keywordSupportedModels.includes(selectedModel)) {
            keywordsSection.style.display = 'block';
        } else {
            keywordsSection.style.display = 'none';
        }
        
        // Show/hide keyterms based on model
        if (keytermSupportedModels.includes(selectedModel)) {
            keytermsSection.style.display = 'block';
        } else {
            keytermsSection.style.display = 'none';
        }
    }
    
    // Initialize visibility on page load
    if (sttModelSelect) {
        updateKeywordVisibility();
        sttModelSelect.addEventListener('change', updateKeywordVisibility);
    }

    // Handle custom inputs
    const customInputs = {
        'llm_model': 'custom_llm_model_container',
        'tts_voice_id': 'custom_voice_container',
        'stt_language': 'custom_language_container',
        'phone_number': 'custom_phone_container'
    };

    Object.entries(customInputs).forEach(([selectId, containerId]) => {
        const select = document.getElementById(selectId);
        const container = document.getElementById(containerId);
        if (select && container) {
            // Check if current value is custom
            const customInput = container.querySelector('input');
            if (customInput && customInput.value && !select.querySelector(`option[value="${customInput.value}"]`)) {
                select.value = 'custom';
                container.classList.remove('hidden');
                customInput.name = selectId;
                select.name = `_${selectId}_dropdown`;
            }

            select.addEventListener('change', function() {
                if (this.value === 'custom') {
                    container.classList.remove('hidden');
                    const customInput = container.querySelector('input');
                    if (customInput) {
                        customInput.name = selectId;
                        this.name = `_${selectId}_dropdown`;
                    }
                } else {
                    container.classList.add('hidden');
                    const customInput = container.querySelector('input');
                    if (customInput) {
                        customInput.name = `_custom_${selectId}`;
                        this.name = selectId;
                    }
                }
            });
        }
    });
    
    // Initialize Twilio credentials monitoring for phone number loading
    initializeTwilioPhoneNumberLoader();
});

// Twilio phone number loading functionality
function initializeTwilioPhoneNumberLoader() {
    const accountSidInput = document.getElementById('twilio_account_sid');
    const authTokenInput = document.getElementById('twilio_auth_token');
    const loadNumbersSection = document.getElementById('load_numbers_section');
    const loadNumbersBtn = document.getElementById('load_phone_numbers_btn');
    
    // Show/hide load numbers section based on credentials
    function checkTwilioCredentials() {
        if (accountSidInput && authTokenInput && loadNumbersSection) {
            const hasCredentials = accountSidInput.value.trim() && authTokenInput.value.trim();
            if (hasCredentials) {
                loadNumbersSection.classList.remove('hidden');
            } else {
                loadNumbersSection.classList.add('hidden');
            }
        }
    }
    
    // Monitor credential inputs
    if (accountSidInput && authTokenInput) {
        accountSidInput.addEventListener('input', checkTwilioCredentials);
        authTokenInput.addEventListener('input', checkTwilioCredentials);
        
        // Check initial state
        checkTwilioCredentials();
    }
    
    // Handle load phone numbers button click
    if (loadNumbersBtn) {
        loadNumbersBtn.addEventListener('click', loadPhoneNumbers);
    }
}

async function loadPhoneNumbers() {
    const accountSidInput = document.getElementById('twilio_account_sid');
    const authTokenInput = document.getElementById('twilio_auth_token');
    const loadingIndicator = document.getElementById('loading_indicator');
    const loadError = document.getElementById('load_error');
    const phoneNumberSection = document.getElementById('phone_number_section');
    
    if (!accountSidInput || !authTokenInput) {
        return;
    }
    
    const accountSid = accountSidInput.value.trim();
    const authToken = authTokenInput.value.trim();
    
    if (!accountSid || !authToken) {
        if (loadError) {
            loadError.textContent = 'Please enter both Account SID and Auth Token';
            loadError.classList.remove('hidden');
        }
        return;
    }
    
    // Show loading, hide error
    if (loadingIndicator) loadingIndicator.classList.remove('hidden');
    if (loadError) loadError.classList.add('hidden');
    
    try {
        const formData = new FormData();
        formData.append('twilio_account_sid', accountSid);
        formData.append('twilio_auth_token', authToken);
        
        const response = await fetch('/assistants/fetch-phone-numbers', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success && result.phone_numbers.length > 0) {
            // Update phone number section with loaded numbers
            updatePhoneNumberSection(result.phone_numbers);
            if (loadError) {
                loadError.textContent = result.message;
                loadError.classList.remove('hidden');
                loadError.className = loadError.className.replace('text-red-400', 'text-green-400');
            }
        } else {
            if (loadError) {
                loadError.textContent = result.error || 'No phone numbers found';
                loadError.className = loadError.className.replace('text-green-400', 'text-red-400');
                loadError.classList.remove('hidden');
            }
        }
    } catch (error) {
        if (loadError) {
            loadError.textContent = 'Failed to load phone numbers: ' + error.message;
            loadError.className = loadError.className.replace('text-green-400', 'text-red-400');
            loadError.classList.remove('hidden');
        }
    } finally {
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
    }
}

function updatePhoneNumberSection(phoneNumbers) {
    const phoneNumberSection = document.getElementById('phone_number_section');
    if (!phoneNumberSection) return;
    
    // Create new select element with loaded phone numbers
    const selectHTML = `
        <select name="phone_number" id="phone_number" required
            class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            <option value="">-- Select a phone number --</option>
            ${phoneNumbers.map(phone => 
                `<option value="${phone.phone_number}">${phone.friendly_name} (${phone.phone_number})</option>`
            ).join('')}
            <option value="custom">Custom phone number</option>
        </select>
        <div id="custom_phone_container" class="mt-3 hidden">
            <input type="text" id="custom_phone_number" placeholder="+1234567890"
                class="block w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
            <p class="mt-2 text-xs text-gray-400">Enter in E.164 format (e.g., +1234567890)</p>
        </div>
    `;
    
    phoneNumberSection.innerHTML = selectHTML;
    
    // Re-initialize custom phone number handling
    const phoneSelect = document.getElementById('phone_number');
    const customContainer = document.getElementById('custom_phone_container');
    if (phoneSelect && customContainer) {
        phoneSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customContainer.classList.remove('hidden');
                const customInput = customContainer.querySelector('input');
                if (customInput) {
                    customInput.name = 'phone_number';
                    this.name = '_phone_number_dropdown';
                }
            } else {
                customContainer.classList.add('hidden');
                const customInput = customContainer.querySelector('input');
                if (customInput) {
                    customInput.name = '_custom_phone_number';
                    this.name = 'phone_number';
                }
            }
        });
    }
}

// LLM Provider management functions
function updateProviderOptions() {
    const provider = document.getElementById('llm_provider').value;
    const modelSelect = document.getElementById('llm_provider_model');
    const apiKeyHelp = document.getElementById('api-key-help');
    const baseUrlContainer = document.getElementById('base-url-container');
    const baseUrlHelp = document.getElementById('base-url-help');
    const modelHelpContent = document.getElementById('model-help-content');
    
    // Clear existing options
    modelSelect.innerHTML = '';
    
    // Provider-specific configurations
    const providerConfigs = {
        openai: {
            models: [
                { value: 'gpt-4o', label: 'üöÄ GPT-4o (Most Advanced)' },
                { value: 'gpt-4o-mini', label: '‚ö° GPT-4o Mini (Fast & Efficient)' },
                { value: 'gpt-3.5-turbo', label: 'üí∞ GPT-3.5 Turbo (Cost Effective)' }
            ],
            apiKeyHelp: 'Enter your OpenAI API key from platform.openai.com',
            showBaseUrl: false,
            baseUrlHelp: '',
            modelHelp: [
                '<div><strong>GPT-4o:</strong> Most advanced, best for complex conversations</div>',
                '<div><strong>GPT-4o-mini:</strong> Faster and cheaper, good balance</div>',
                '<div><strong>GPT-3.5-turbo:</strong> Fast and cost-effective for simple tasks</div>'
            ]
        },
        anthropic: {
            models: [
                { value: 'claude-3-5-sonnet-latest', label: 'üß† Claude 3.5 Sonnet (Recommended)' },
                { value: 'claude-3-haiku-20240307', label: '‚ö° Claude 3 Haiku (Fast)' }
            ],
            apiKeyHelp: 'Enter your Anthropic API key from console.anthropic.com',
            showBaseUrl: false,
            baseUrlHelp: '',
            modelHelp: [
                '<div><strong>Claude 3.5 Sonnet:</strong> Advanced reasoning and safety</div>',
                '<div><strong>Claude 3 Haiku:</strong> Fast and efficient</div>'
            ]
        },
        gemini: {
            models: [
                { value: 'gemini-2.0-flash', label: 'üåü Gemini 2.0 Flash (Latest)' },
                { value: 'gemini-1.5-pro', label: '‚≠ê Gemini 1.5 Pro' }
            ],
            apiKeyHelp: 'Enter your Google AI API key from aistudio.google.com',
            showBaseUrl: true,
            baseUrlHelp: 'Google Gemini OpenAI-compatible endpoint (auto-filled)',
            modelHelp: [
                '<div><strong>Gemini 2.0 Flash:</strong> Latest Google model with multimodal capabilities</div>',
                '<div><strong>Gemini 1.5 Pro:</strong> Powerful reasoning and long context</div>'
            ]
        },
        xai: {
            models: [
                { value: 'grok-beta', label: '‚ö° Grok Beta (Recommended)' },
                { value: 'grok-2-1212', label: 'üöÄ Grok 2 (Latest)' }
            ],
            apiKeyHelp: 'Enter your xAI API key from console.x.ai',
            showBaseUrl: true,
            baseUrlHelp: 'xAI API endpoint (auto-filled)',
            modelHelp: [
                '<div><strong>Grok Beta:</strong> Real-time information and less restrictive</div>',
                '<div><strong>Grok 2:</strong> Latest and most capable Grok model</div>'
            ]
        },
        groq: {
            models: [
                { value: 'llama-3.3-70b-versatile', label: 'üî• Llama 3.3 70B (Recommended)' },
                { value: 'llama-3.1-8b-instant', label: '‚ö° Llama 3.1 8B (Ultra Fast)' }
            ],
            apiKeyHelp: 'Enter your Groq API key from console.groq.com',
            showBaseUrl: false,
            baseUrlHelp: '',
            modelHelp: [
                '<div><strong>Llama 3.3 70B:</strong> High quality with ultra-fast inference</div>',
                '<div><strong>Llama 3.1 8B:</strong> Extremely fast for simple tasks</div>'
            ]
        },
        custom: {
            models: [
                { value: '', label: 'Enter custom model name' }
            ],
            apiKeyHelp: 'Enter API key if required by your custom endpoint',
            showBaseUrl: true,
            baseUrlHelp: 'Your custom API endpoint URL (e.g., https://api.yourservice.com/v1)',
            modelHelp: [
                '<div><strong>Custom Model:</strong> Specify your model name or leave blank</div>'
            ]
        }
    };
    
    const config = providerConfigs[provider] || providerConfigs.openai;
    
    // Populate model options
    config.models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = model.label;
        modelSelect.appendChild(option);
    });
    
    // Set selected model if editing existing assistant
    if (ASSISTANT_DATA.model && ASSISTANT_DATA.provider === provider) {
        const currentModel = ASSISTANT_DATA.model;
        if (modelSelect.querySelector(`option[value="${currentModel}"]`)) {
            modelSelect.value = currentModel;
        }
    }
    
    // Update help text
    apiKeyHelp.textContent = config.apiKeyHelp;
    baseUrlHelp.textContent = config.baseUrlHelp;
    modelHelpContent.innerHTML = config.modelHelp.join('');
    
    // Show/hide base URL field
    if (config.showBaseUrl) {
        baseUrlContainer.classList.remove('hidden');
        // Auto-fill base URL for some providers
        if (provider === 'gemini' && !document.getElementById('llm_provider_base_url').value) {
            document.getElementById('llm_provider_base_url').value = 'https://generativelanguage.googleapis.com/v1beta/openai/';
        } else if (provider === 'xai' && !document.getElementById('llm_provider_base_url').value) {
            document.getElementById('llm_provider_base_url').value = 'https://api.x.ai/v1';
        }
    } else {
        baseUrlContainer.classList.add('hidden');
    }
    
    // For custom provider, make model input text instead of select
    if (provider === 'custom') {
        modelSelect.innerHTML = '<option value="">Enter model name...</option>';
        // Convert to text input
        const modelInput = document.createElement('input');
        modelInput.type = 'text';
        modelInput.name = 'llm_provider_model';
        modelInput.id = 'llm_provider_model';
        modelInput.className = modelSelect.className;
        modelInput.placeholder = 'Enter your custom model name';
        if (ASSISTANT_DATA.provider === 'custom' && ASSISTANT_DATA.model) {
            modelInput.value = ASSISTANT_DATA.model;
        }
        modelSelect.parentNode.replaceChild(modelInput, modelSelect);
    } else {
        // Ensure we have a select element (not text input)
        const currentModelField = document.getElementById('llm_provider_model');
        if (currentModelField.tagName === 'INPUT') {
            const newSelect = document.createElement('select');
            newSelect.name = 'llm_provider_model';
            newSelect.id = 'llm_provider_model';
            newSelect.className = currentModelField.className;
            currentModelField.parentNode.replaceChild(newSelect, currentModelField);
            
            // Re-populate options
            config.models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                newSelect.appendChild(option);
            });
            
            // Set selected model if editing existing assistant
            if (ASSISTANT_DATA.model && ASSISTANT_DATA.provider === provider) {
                const currentModel = ASSISTANT_DATA.model;
                if (newSelect.querySelector(`option[value="${currentModel}"]`)) {
                    newSelect.value = currentModel;
                }
            }
        }
    }
}

function initializeDataFields() {
    try {
        // Check if there's existing schema data
        const existingSchema = '{{ (assistant.custom_settings.structured_data_schema | tojson) if assistant and assistant.custom_settings and assistant.custom_settings.get("structured_data_schema") else "{}" }}';
        const schema = JSON.parse(existingSchema.replace(/'/g, '"'));
        
        if (schema && schema.properties && Object.keys(schema.properties).length > 0) {
            // Load existing fields
            Object.entries(schema.properties).forEach(([key, field]) => {
                const fieldData = {
                    name: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    type: field.enum ? 'enum' : field.type || 'string',
                    description: field.description || '',
                    required: schema.required && schema.required.includes(key),
                    enum: field.enum || null
                };
                addDataField(fieldData);
            });
        } else {
            // Add one default field to show users how it works
            addDataField({ 
                name: "Call Topic", 
                type: "string", 
                description: "The main topic or purpose of the call", 
                required: true 
            });
        }
    } catch (e) {
        // If there's an error parsing existing data, just add a default field
        addDataField({ 
            name: "Call Topic", 
            type: "string", 
            description: "The main topic or purpose of the call", 
            required: true 
        });
    }
}

function toggleEnumOptions(selectElement) {
    const fieldContainer = selectElement.closest('.data-field');
    const enumContainer = fieldContainer.querySelector('.enum-options');
    
    if (selectElement.value === 'enum') {
        enumContainer.classList.remove('hidden');
    } else {
        enumContainer.classList.add('hidden');
    }
}

function addEnumOption(fieldId) {
    const field = document.querySelector(`[data-field-id="${fieldId}"]`);
    const enumValues = field.querySelector('.enum-values');
    
    const optionHtml = `
        <div class="flex items-center space-x-2">
            <input type="text" class="enum-value flex-1 px-2 py-1 text-xs bg-gray-700/50 border border-gray-600 rounded text-white placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" 
                   placeholder="New option" onchange="updateSchema()">
            <button type="button" onclick="removeEnumOption(this)" class="px-2 py-1 text-xs text-red-300 hover:text-red-200 bg-red-500/20 hover:bg-red-500/30 rounded">‚úï</button>
        </div>
    `;
    
    enumValues.insertAdjacentHTML('beforeend', optionHtml);
    updateSchema();
}

function removeEnumOption(button) {
    const optionContainer = button.closest('.flex');
    optionContainer.remove();
    updateSchema();
}

// Template variables
const ASSISTANT_DATA = {
    provider: "{{ assistant.llm_provider if assistant and assistant.llm_provider else 'openai' }}",
    model: "{{ assistant.llm_provider_config.model if assistant and assistant.llm_provider_config and assistant.llm_provider_config.get('model') else '' }}",
    apiKey: "{{ assistant.llm_provider_config.api_key if assistant and assistant.llm_provider_config and assistant.llm_provider_config.get('api_key') else '' }}",
    baseUrl: "{{ assistant.llm_provider_config.base_url if assistant and assistant.llm_provider_config and assistant.llm_provider_config.get('base_url') else '' }}",
    ttsProvider: "{{ assistant.tts_settings.provider if assistant and assistant.tts_settings and assistant.tts_settings.get('provider') else 'elevenlabs' }}",
    ttsVoice: "{{ assistant.tts_settings.voice_id if assistant and assistant.tts_settings and assistant.tts_settings.voice_id else 'rachel' }}",
    ttsModel: "{{ assistant.tts_settings.model_id if assistant and assistant.tts_settings and assistant.tts_settings.model_id else 'turbo' }}",
    ttsLanguage: "{{ assistant.tts_settings.provider_config.language if assistant and assistant.tts_settings and assistant.tts_settings.get('provider_config') and assistant.tts_settings.provider_config.get('language') else 'en' }}",
    fallbacks: {% if assistant and assistant.llm_fallback_providers and assistant.llm_fallback_providers.get('fallbacks') %}{{ assistant.llm_fallback_providers.fallbacks | tojson | safe }}{% else %}[]{% endif %}
};

// TTS Provider management functions
function updateTTSProviderOptions() {
    const provider = document.getElementById('tts_provider').value;
    const modelSelect = document.getElementById('tts_model_id');
    const voiceSelect = document.getElementById('tts_voice_id');
    const modelHelpDiv = document.getElementById('tts-model-help');
    const modelRecommendationDiv = document.getElementById('tts-model-recommendation');
    const customVoiceHelp = document.getElementById('custom-voice-help');
    
    // Show/hide provider-specific settings
    const elevenlabsSettings = document.getElementById('elevenlabs-settings');
    const deepgramSettings = document.getElementById('deepgram-settings');
    const inworldSettings = document.getElementById('inworld-settings');
    const resembleSettings = document.getElementById('resemble-settings');

    if (provider === 'elevenlabs') {
        elevenlabsSettings.classList.remove('hidden');
        deepgramSettings.classList.add('hidden');
        inworldSettings.classList.add('hidden');
        resembleSettings.classList.add('hidden');
    } else if (provider === 'deepgram') {
        elevenlabsSettings.classList.add('hidden');
        deepgramSettings.classList.remove('hidden');
        inworldSettings.classList.add('hidden');
        resembleSettings.classList.add('hidden');
    } else if (provider === 'inworld') {
        elevenlabsSettings.classList.add('hidden');
        deepgramSettings.classList.add('hidden');
        inworldSettings.classList.remove('hidden');
        resembleSettings.classList.add('hidden');
    } else if (provider === 'resemble') {
        elevenlabsSettings.classList.add('hidden');
        deepgramSettings.classList.add('hidden');
        inworldSettings.classList.add('hidden');
        resembleSettings.classList.remove('hidden');
    }
    
    // Clear existing options
    modelSelect.innerHTML = '';
    voiceSelect.innerHTML = '';
    
    // Provider-specific configurations
    const ttsProviderConfigs = {
        elevenlabs: {
            models: [
                { value: 'eleven_multilingual_v2', label: 'üé≠ Multilingual v2 (Best Quality)' },
                { value: 'eleven_flash_v2_5', label: '‚ö° Flash v2.5 (Ultra Fast - Recommended)' },
                { value: 'eleven_turbo_v2_5', label: 'üöÄ Turbo v2.5 (Balanced)' }
            ],
            voices: [
                { value: 'rachel', label: 'üë© Rachel (Professional Female)' },
                { value: 'domi', label: 'üë©‚Äçüíº Domi (Warm Female)' },
                { value: 'bella', label: 'üåü Bella (Friendly Female)' },
                { value: 'antoni', label: 'üë® Antoni (Calm Male)' },
                { value: 'eli', label: 'üë®‚Äçüíº Eli (Professional Male)' },
                { value: 'josh', label: 'üéØ Josh (Confident Male)' },
                { value: 'custom', label: 'üîß Custom Voice ID' }
            ],
            modelHelp: [
                '<div><strong>Multilingual v2:</strong> Highest quality, most natural emotions (slower)</div>',
                '<div><strong>Flash v2.5:</strong> Ultra-fast (~75ms), great for real-time conversations</div>',
                '<div><strong>Turbo v2.5:</strong> Good balance of speed and quality</div>'
            ],
            recommendation: '<p class="text-xs text-blue-200"><strong>üí° For Phone Calls:</strong> Flash v2.5 is recommended for natural conversations. Multilingual v2 if you prioritize voice quality over speed.</p>',
            customVoiceHelp: 'Enter your custom ElevenLabs voice ID from your dashboard'
        },
        deepgram: {
            models: [
                { value: 'aura-2', label: 'üåü Aura-2 (Latest Generation - Recommended)' },
                { value: 'aura', label: '‚ö° Aura (Original - Fast)' }
            ],
            voices: [
                { value: 'asteria', label: 'üë© Asteria (Clear & Professional Female)' },
                { value: 'luna', label: 'üåô Luna (Warm & Friendly Female)' },
                { value: 'stella', label: '‚≠ê Stella (Energetic & Bright Female)' },
                { value: 'athena', label: 'ü¶â Athena (Sophisticated UK Female)' },
                { value: 'hera', label: 'üëë Hera (Confident & Authoritative Female)' },
                { value: 'orion', label: 'üë® Orion (Deep & Resonant Male)' },
                { value: 'arcas', label: '‚öîÔ∏è Arcas (Strong & Commanding Male)' },
                { value: 'perseus', label: 'üèõÔ∏è Perseus (Smooth & Professional Male)' },
                { value: 'zeus', label: '‚ö° Zeus (Powerful & Authoritative Male)' },
                { value: 'thalia', label: 'üé≠ Thalia (Aura-2 Professional Female)' },
                { value: 'aurora', label: 'üåÖ Aurora (Aura-2 Warm Female)' }
            ],
            modelHelp: [
                '<div><strong>Aura-2:</strong> Latest generation with enhanced quality and naturalness</div>',
                '<div><strong>Aura:</strong> Original generation, optimized for ultra-low latency</div>'
            ],
            recommendation: '<p class="text-xs text-green-200"><strong>üöÄ Ultra-Fast TTS:</strong> Deepgram Aura is 3x faster than ElevenLabs, perfect for real-time AI conversations. Aura-2 offers the best quality.</p>',
            customVoiceHelp: 'Enter your custom Deepgram Aura voice model ID'
        },
        inworld: {
            models: [
                { value: 'inworld-tts-1', label: 'üé™ Inworld TTS-1 (Flagship Model)' },
                { value: 'inworld-tts-1-max', label: 'üåü Inworld TTS-1-Max (More Expressive - Experimental)' }
            ],
            // Language-specific voices for Inworld
            voicesByLanguage: {
                'en': [
                    { value: 'hades', label: 'üë® Hades (Deep & Commanding Male)' },
                    { value: 'alex', label: 'üë® Alex (Clear & Natural Male)' },
                    { value: 'ashley', label: 'üë© Ashley (Warm & Friendly Female)' },
                    { value: 'aria', label: 'üë© Aria (Professional Female)' },
                    { value: 'ethan', label: 'üë® Ethan (Friendly Male)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'es': [
                    { value: 'diego', label: 'üë® Diego (Warm & Expressive Male)' },
                    { value: 'lupita', label: 'üë© Lupita (Elegant & Clear Female)' },
                    { value: 'miguel', label: 'üë® Miguel (Strong & Confident Male)' },
                    { value: 'rafael', label: 'üë® Rafael (Smooth & Professional Male)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'fr': [
                    { value: 'alain', label: 'üë® Alain (Sophisticated Male)' },
                    { value: 'helene', label: 'üë© H√©l√®ne (Graceful & Articulate Female)' },
                    { value: 'mathieu', label: 'üë® Mathieu (Clear & Natural Male)' },
                    { value: 'etienne', label: 'üë® √âtienne (Expressive & Warm Male)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'de': [
                    { value: 'johanna', label: 'üë© Johanna (Precise & Professional Female)' },
                    { value: 'josef', label: 'üë® Josef (Strong & Clear Male)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'zh': [
                    { value: 'yichen', label: 'üë® Yichen (Natural & Expressive Male)' },
                    { value: 'xiaoyin', label: 'üë© Xiaoyin (Melodic & Clear Female)' },
                    { value: 'xinyi', label: 'üë© Xinyi (Gentle & Articulate Female)' },
                    { value: 'jing', label: 'üë© Jing (Smooth & Professional Female)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'it': [
                    { value: 'marco', label: 'üë® Marco (Expressive & Warm Male)' },
                    { value: 'giulia', label: 'üë© Giulia (Elegant & Musical Female)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'pt': [
                    { value: 'joao', label: 'üë® Jo√£o (Rich & Warm Male)' },
                    { value: 'ana', label: 'üë© Ana (Smooth & Expressive Female)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'ja': [
                    { value: 'hiroshi', label: 'üë® Hiroshi (Polite & Clear Male)' },
                    { value: 'sakura', label: 'üë© Sakura (Gentle & Melodic Female)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'nl': [
                    { value: 'jan', label: 'üë® Jan (Friendly & Clear Male)' },
                    { value: 'emma', label: 'üë© Emma (Warm & Approachable Female)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'ko': [
                    { value: 'min', label: 'üë® Min (Professional & Clear Male)' },
                    { value: 'soo', label: 'üë© Soo (Gentle & Articulate Female)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ],
                'pl': [
                    { value: 'piotr', label: 'üë® Piotr (Strong & Expressive Male)' },
                    { value: 'anna', label: 'üë© Anna (Clear & Professional Female)' },
                    { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
                ]
            },
            // Fallback voices (same as English for backward compatibility)
            voices: [
                { value: 'hades', label: 'üë® Hades (Deep & Commanding Male)' },
                { value: 'alex', label: 'üë® Alex (Clear & Natural Male)' },
                { value: 'ashley', label: 'üë© Ashley (Warm & Friendly Female)' },
                { value: 'aria', label: 'üë© Aria (Professional Female)' },
                { value: 'ethan', label: 'üë® Ethan (Friendly Male)' },
                { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
            ],
            languages: [
                { value: 'en', label: 'üá∫üá∏ English (Production)', status: 'production' },
                { value: 'zh', label: 'üá®üá≥ Chinese (Production)', status: 'production' },
                { value: 'ko', label: 'üá∞üá∑ Korean (Production)', status: 'production' },
                { value: 'nl', label: 'üá≥üá± Dutch (Production)', status: 'production' },
                { value: 'fr', label: 'üá´üá∑ French (Production)', status: 'production' },
                { value: 'es', label: 'üá™üá∏ Spanish (Production)', status: 'production' },
                { value: 'ja', label: 'üáØüáµ Japanese (Experimental)', status: 'experimental' },
                { value: 'de', label: 'üá©üá™ German (Experimental)', status: 'experimental' },
                { value: 'it', label: 'üáÆüáπ Italian (Experimental)', status: 'experimental' },
                { value: 'pl', label: 'üáµüá± Polish (Experimental)', status: 'experimental' },
                { value: 'pt', label: 'üáßüá∑ Portuguese (Experimental)', status: 'experimental' }
            ],
            modelHelp: [
                '<div><strong>TTS-1:</strong> Flagship model with realistic, context-aware speech synthesis and zero-shot voice cloning</div>',
                '<div><strong>TTS-1-Max:</strong> Larger, more expressive model with enhanced emotional nuance (experimental)</div>'
            ],
            recommendation: '<p class="text-xs text-purple-200"><strong>üé™ AI-Powered TTS:</strong> Inworld.ai offers advanced voice cloning, multi-language support, and emotional markup. Use custom voice IDs for personalized experiences.</p>',
            customVoiceHelp: 'Enter your custom Inworld voice ID for voice cloning or personalized voices'
        },
        resemble: {
            models: [
                { value: 'default', label: 'üéØ Default (WebSocket Streaming)' }
            ],
            voices: [
                { value: 'custom', label: 'üîß Enter Voice UUID' }
            ],
            modelHelp: [
                '<div><strong>Default:</strong> Resemble AI uses a single high-quality model optimized for WebSocket streaming</div>'
            ],
            recommendation: '<p class="text-xs text-purple-200"><strong>üéØ Voice Configuration:</strong> Resemble AI requires your custom voice UUID from your dashboard. Each voice is unique to your account.</p>',
            customVoiceHelp: 'Enter your Resemble AI voice UUID from your dashboard (required)',
            alwaysCustom: true
        },
    };
    
    const config = ttsProviderConfigs[provider] || ttsProviderConfigs.elevenlabs;
    
    // Populate model options
    config.models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = model.label;
        modelSelect.appendChild(option);
    });
    
    // Populate voice options with language filtering for Inworld
    if (provider === 'inworld') {
        updateInworldVoices();
    } else {
        // For other providers, use regular voices
        config.voices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.value;
            option.textContent = voice.label;
            voiceSelect.appendChild(option);
        });
    }
    
    // Set selected values if editing existing assistant
    if (ASSISTANT_DATA.ttsProvider === provider) {
        if (ASSISTANT_DATA.ttsModel && modelSelect.querySelector('option[value="' + ASSISTANT_DATA.ttsModel + '"]')) {
            modelSelect.value = ASSISTANT_DATA.ttsModel;
        }
        if (ASSISTANT_DATA.ttsVoice) {
            if (voiceSelect.querySelector('option[value="' + ASSISTANT_DATA.ttsVoice + '"]')) {
                voiceSelect.value = ASSISTANT_DATA.ttsVoice;
            } else if (provider === 'elevenlabs') {
                // Custom voice ID only supported by ElevenLabs
                voiceSelect.value = 'custom';
                const customContainer = document.getElementById('custom_voice_container');
                const customInput = document.getElementById('custom_voice_id');
                customContainer.classList.remove('hidden');
                customInput.value = ASSISTANT_DATA.ttsVoice;
                customInput.name = 'tts_voice_id';
                voiceSelect.name = '_tts_voice_id_dropdown';
            } else if (provider === 'resemble') {
                // Custom voice UUID also supported by Resemble AI
                voiceSelect.value = 'custom';
                const customContainer = document.getElementById('custom_voice_container');
                const customInput = document.getElementById('custom_voice_id');
                customContainer.classList.remove('hidden');
                customInput.value = ASSISTANT_DATA.ttsVoice;
                customInput.name = 'tts_voice_id';
                voiceSelect.name = '_tts_voice_id_dropdown';
            }
        }
    }

    // Handle providers that always require custom input (like Resemble)
    if (config.alwaysCustom) {
        voiceSelect.value = 'custom';
        const customContainer = document.getElementById('custom_voice_container');
        const customInput = document.getElementById('custom_voice_id');
        customContainer.classList.remove('hidden');
        if (ASSISTANT_DATA.ttsProvider === provider && ASSISTANT_DATA.ttsVoice) {
            customInput.value = ASSISTANT_DATA.ttsVoice;
        }
        customInput.name = 'tts_voice_id';
        voiceSelect.name = '_tts_voice_id_dropdown';
    }
    // Ensure custom voice container is hidden for Deepgram (they don't support custom voices)
    const customContainer = document.getElementById('custom_voice_container');
    if (provider === 'deepgram') {
        customContainer.classList.add('hidden');
        const customInput = document.getElementById('custom_voice_id');
        customInput.name = '_custom_tts_voice_id';
        voiceSelect.name = 'tts_voice_id';
    }
    
    // Update help content
    if (modelHelpDiv) modelHelpDiv.innerHTML = config.modelHelp.join('');
    if (modelRecommendationDiv) modelRecommendationDiv.innerHTML = config.recommendation;
    if (customVoiceHelp) customVoiceHelp.textContent = config.customVoiceHelp;
    
    // Handle custom voice selection
    voiceSelect.addEventListener('change', function() {
        const customContainer = document.getElementById('custom_voice_container');
        const customInput = document.getElementById('custom_voice_id');
        
        if (this.value === 'custom' && (provider === 'elevenlabs' || provider === 'resemble')) {
            customContainer.classList.remove('hidden');
            customInput.name = 'tts_voice_id';
            this.name = '_tts_voice_id_dropdown';
        } else {
            customContainer.classList.add('hidden');
            customInput.name = '_custom_tts_voice_id';
            this.name = 'tts_voice_id';
        }
    });
}

// Update Inworld voices based on selected language
function updateInworldVoices() {
    const languageSelect = document.getElementById('tts_language');
    const voiceSelect = document.getElementById('tts_voice_id');
    
    if (!languageSelect || !voiceSelect) return;
    
    const selectedLanguage = languageSelect.value || 'en';
    
    // Language-specific voices for Inworld
    const voicesByLanguage = {
        'en': [
            { value: 'hades', label: 'üë® Hades (Deep & Commanding Male)' },
            { value: 'alex', label: 'üë® Alex (Clear & Natural Male)' },
            { value: 'ashley', label: 'üë© Ashley (Warm & Friendly Female)' },
            { value: 'aria', label: 'üë© Aria (Professional Female)' },
            { value: 'ethan', label: 'üë® Ethan (Friendly Male)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'es': [
            { value: 'diego', label: 'üë® Diego (Warm & Expressive Male)' },
            { value: 'lupita', label: 'üë© Lupita (Elegant & Clear Female)' },
            { value: 'miguel', label: 'üë® Miguel (Strong & Confident Male)' },
            { value: 'rafael', label: 'üë® Rafael (Smooth & Professional Male)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'fr': [
            { value: 'alain', label: 'üë® Alain (Sophisticated Male)' },
            { value: 'helene', label: 'üë© H√©l√®ne (Graceful & Articulate Female)' },
            { value: 'mathieu', label: 'üë® Mathieu (Clear & Natural Male)' },
            { value: 'etienne', label: 'üë® √âtienne (Expressive & Warm Male)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'de': [
            { value: 'johanna', label: 'üë© Johanna (Precise & Professional Female)' },
            { value: 'josef', label: 'üë® Josef (Strong & Clear Male)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'zh': [
            { value: 'yichen', label: 'üë® Yichen (Natural & Expressive Male)' },
            { value: 'xiaoyin', label: 'üë© Xiaoyin (Melodic & Clear Female)' },
            { value: 'xinyi', label: 'üë© Xinyi (Gentle & Articulate Female)' },
            { value: 'jing', label: 'üë© Jing (Smooth & Professional Female)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'it': [
            { value: 'marco', label: 'üë® Marco (Expressive & Warm Male)' },
            { value: 'giulia', label: 'üë© Giulia (Elegant & Musical Female)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'pt': [
            { value: 'joao', label: 'üë® Jo√£o (Rich & Warm Male)' },
            { value: 'ana', label: 'üë© Ana (Smooth & Expressive Female)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'ja': [
            { value: 'hiroshi', label: 'üë® Hiroshi (Polite & Clear Male)' },
            { value: 'sakura', label: 'üë© Sakura (Gentle & Melodic Female)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'nl': [
            { value: 'jan', label: 'üë® Jan (Friendly & Clear Male)' },
            { value: 'emma', label: 'üë© Emma (Warm & Approachable Female)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'ko': [
            { value: 'min', label: 'üë® Min (Professional & Clear Male)' },
            { value: 'soo', label: 'üë© Soo (Gentle & Articulate Female)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ],
        'pl': [
            { value: 'piotr', label: 'üë® Piotr (Strong & Expressive Male)' },
            { value: 'anna', label: 'üë© Anna (Clear & Professional Female)' },
            { value: 'custom', label: 'üé≠ Custom Voice ID (Voice Cloning)' }
        ]
    };
    
    // Get voices for selected language (fallback to English if not found)
    const availableVoices = voicesByLanguage[selectedLanguage] || voicesByLanguage['en'];
    
    // Clear existing options
    voiceSelect.innerHTML = '';
    
    // Populate voice options for the selected language
    availableVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.value;
        option.textContent = voice.label;
        voiceSelect.appendChild(option);
    });
    
    // Set selected voice if editing existing assistant
    if (ASSISTANT_DATA.ttsVoice && ASSISTANT_DATA.ttsProvider === 'inworld') {
        if (voiceSelect.querySelector('option[value="' + ASSISTANT_DATA.ttsVoice + '"]')) {
            voiceSelect.value = ASSISTANT_DATA.ttsVoice;
        } else if (ASSISTANT_DATA.ttsVoice !== 'hades' && ASSISTANT_DATA.ttsVoice !== 'custom') {
            // Custom voice ID - select custom option and populate the input
            voiceSelect.value = 'custom';
            const customContainer = document.getElementById('inworld_custom_voice_container');
            const customInput = document.getElementById('custom_voice_id');
            if (customContainer && customInput) {
                customContainer.classList.remove('hidden');
                customInput.value = ASSISTANT_DATA.ttsVoice;
            }
        }
    }
    
    // Handle custom voice selection
    voiceSelect.removeEventListener('change', handleInworldVoiceChange);
    voiceSelect.addEventListener('change', handleInworldVoiceChange);
}

function handleInworldVoiceChange() {
    const voiceSelect = document.getElementById('tts_voice_id');
    const customContainer = document.getElementById('inworld_custom_voice_container');
    
    if (voiceSelect && customContainer) {
        if (voiceSelect.value === 'custom') {
            customContainer.classList.remove('hidden');
        } else {
            customContainer.classList.add('hidden');
        }
    }
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all transform translate-x-full`;
    
    if (type === 'success') {
        notification.classList.add('bg-green-600', 'text-white');
        notification.innerHTML = `‚úÖ ${message}`;
    } else if (type === 'error') {
        notification.classList.add('bg-red-600', 'text-white');
        notification.innerHTML = `‚ùå ${message}`;
    } else {
        notification.classList.add('bg-blue-600', 'text-white');
        notification.innerHTML = `‚ÑπÔ∏è ${message}`;
    }
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

function toggleTools() {
    const section = document.getElementById('tools-configuration');
    const toggle = document.getElementById('tools-toggle-text');
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        toggle.textContent = 'Collapse';
    } else {
        section.classList.add('hidden');
        toggle.textContent = 'Configure';
    }
}

// Fallback providers management functions
function toggleFallbackProviders() {
    const content = document.getElementById('fallback-providers-content');
    const checkbox = document.getElementById('fallback_enabled');
    
    if (checkbox.checked) {
        content.classList.remove('hidden');
    } else {
        content.classList.add('hidden');
    }
}

function toggleFallbackProvider(index) {
    const checkbox = document.querySelector(`input[name="fallback_${index}_enabled"]`);
    const config = checkbox.closest('.fallback-provider').querySelector('.fallback-config');
    
    if (checkbox.checked) {
        config.classList.remove('hidden');
    } else {
        config.classList.add('hidden');
    }
}

function updateFallbackModelOptions(index) {
    const providerSelect = document.querySelector(`select[name="fallback_${index}_provider"]`);
    const modelSelect = document.querySelector(`select[name="fallback_${index}_model"]`);
    const provider = providerSelect.value;
    
    // Clear existing options
    modelSelect.innerHTML = '<option value="">Select Model</option>';
    
    // Provider-specific model configurations (same as main provider)
    const providerConfigs = {
        openai: [
            { value: 'gpt-4o', label: 'üöÄ GPT-4o (Most Advanced)' },
            { value: 'gpt-4o-mini', label: '‚ö° GPT-4o Mini (Fast & Efficient)' },
            { value: 'gpt-3.5-turbo', label: 'üí∞ GPT-3.5 Turbo (Cost Effective)' }
        ],
        anthropic: [
            { value: 'claude-3-5-sonnet-latest', label: 'üß† Claude 3.5 Sonnet (Recommended)' },
            { value: 'claude-3-haiku-20240307', label: '‚ö° Claude 3 Haiku (Fast)' }
        ],
        gemini: [
            { value: 'gemini-2.0-flash', label: 'üåü Gemini 2.0 Flash (Latest)' },
            { value: 'gemini-1.5-pro', label: '‚≠ê Gemini 1.5 Pro' }
        ],
        xai: [
            { value: 'grok-beta', label: '‚ö° Grok Beta (Recommended)' },
            { value: 'grok-2-1212', label: 'üöÄ Grok 2 (Latest)' }
        ],
        groq: [
            { value: 'llama-3.3-70b-versatile', label: 'üî• Llama 3.3 70B (Recommended)' },
            { value: 'llama-3.1-8b-instant', label: '‚ö° Llama 3.1 8B (Ultra Fast)' }
        ],
        custom: [
            { value: '', label: 'Enter custom model name' }
        ]
    };
    
    const config = providerConfigs[provider] || [];
    
    // Populate model options
    config.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = model.label;
        modelSelect.appendChild(option);
    });
    
    // Set selected model if editing existing assistant and there's a match
    if (ASSISTANT_DATA.fallbacks && ASSISTANT_DATA.fallbacks[index]) {
        const currentModel = ASSISTANT_DATA.fallbacks[index].config && ASSISTANT_DATA.fallbacks[index].config.model;
        if (currentModel && modelSelect.querySelector(`option[value="${currentModel}"]`)) {
            modelSelect.value = currentModel;
        }
    }
}

function initializeFallbackProviders() {
    // Initialize fallback model options for each enabled fallback
    for (let i = 0; i < 3; i++) {
        const providerSelect = document.querySelector(`select[name="fallback_${i}_provider"]`);
        if (providerSelect && providerSelect.value) {
            updateFallbackModelOptions(i);
        }
    }
}
</script>
{% endblock %} 
